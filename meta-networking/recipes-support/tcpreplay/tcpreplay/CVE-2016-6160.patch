From c81307df429ac43322e40edde421429e4cd8bcc9 Mon Sep 17 00:00:00 2001
From: Fred Klassen <fklassen@appneta.com>
Date: Sat, 19 Nov 2016 06:32:08 -0800
Subject: [PATCH] #251 allow 65549 byte frame size (#264)

---
 configure.ac     |    2 +-
 docs/CHANGELOG   |    6 ++++++
 src/defines.h.in |    2 +-
 src/tcprewrite.c |    2 ++
 4 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index e882dbd..9330c91 100644
--- a/configure.ac
+++ b/configure.ac
@@ -2,7 +2,7 @@
 dnl $Id$
 
 AC_PREREQ([2.69])
-AC_INIT([tcpreplay],[4.1.1],[https://github.com/appneta/tcpreplay/issues],[tcpreplay],[http://tcpreplay.sourceforge.net/])
+AC_INIT([tcpreplay],[4.1.2],[https://github.com/appneta/tcpreplay/issues],[tcpreplay],[http://tcpreplay.sourceforge.net/])
 AC_CONFIG_SRCDIR([src/tcpreplay.c])
 AM_CONFIG_HEADER([src/config.h])
 AC_CONFIG_AUX_DIR(config)
diff --git a/docs/CHANGELOG b/docs/CHANGELOG
index d8491d1..2b9b0f6 100644
--- a/docs/CHANGELOG
+++ b/docs/CHANGELOG
@@ -1,3 +1,9 @@
+11/19/2016 Version 4.1.2
+    - Fix compilation with musl C library (#260)
+    - Give user CFLAGS precedence (#256)
+    - Increase max packet size to 65549 (#251)
+    - Handle IP headers with zero length (#247)
+
 01/11/2016 Version 4.1.1
     - Improve --pps accuracy and performance (#236)
     - Option --unique-ip accepts --duration (#227)
diff --git a/src/defines.h.in b/src/defines.h.in
index 024c949..00e547f 100644
--- a/src/defines.h.in
+++ b/src/defines.h.in
@@ -145,7 +145,7 @@ typedef struct tcpr_speed_s {
 #define DEFAULT_MTU 1500        /* Max Transmission Unit of standard ethernet
                                  * don't forget *frames* are MTU + L2 header! */
 
-#define MAXPACKET 65535         /* was 16436 linux loopback, but maybe something is bigger then
+#define MAXPACKET 65549         /* was 16436 linux loopback, but maybe something is bigger then
                                    linux loopback */
 
 #define MAX_SNAPLEN 65535       /* tell libpcap to capture the entire packet */
diff --git a/src/tcprewrite.c b/src/tcprewrite.c
index d860bca..5688588 100644
--- a/src/tcprewrite.c
+++ b/src/tcprewrite.c
@@ -250,6 +250,8 @@ rewrite_packets(tcpedit_t *tcpedit, pcap_t *pin, pcap_dumper_t *pout)
         packetnum++;
         dbgx(2, "packet " COUNTER_SPEC " caplen %d", packetnum, pkthdr.caplen);
 
+        if (pkthdr.caplen > MAXPACKET)
+            errx(-1, "Frame too big, caplen %d exceeds %d", pkthdr.caplen, MAXPACKET);
         /* 
          * copy over the packet so we can pad it out if necessary and
          * because pcap_next() returns a const ptr
-- 
1.7.9.5

