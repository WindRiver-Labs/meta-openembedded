From 6b8ed9649e08215cd2acf7702e178ce41b18d932 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 16:28:25 -0700
Subject: [PATCH] CVE-2016-7975/Fix another bounds check.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-tcp.c                      |    2 +-
 tests/TESTLIST                   |    1 +
 tests/tcp-auth-heapoverflow.out  |    2 ++
 tests/tcp-auth-heapoverflow.pcap |  Bin 0 -> 138 bytes
 4 files changed, 4 insertions(+), 1 deletion(-)
 create mode 100644 tests/tcp-auth-heapoverflow.out
 create mode 100644 tests/tcp-auth-heapoverflow.pcap

diff --git a/print-tcp.c b/print-tcp.c
index a1c1dde..3a89e8d 100644
--- a/print-tcp.c
+++ b/print-tcp.c
@@ -550,7 +550,7 @@ tcp_print(netdissect_options *ndo,
                                 ND_PRINT((ndo, "keyid %d", *cp++));
                                 datalen = len - 3;
                                 for (i = 0; i < datalen; ++i) {
-                                        LENCHECK(i);
+                                        LENCHECK(i + 1);
                                         ND_PRINT((ndo, "%02x", cp[i]));
                                 }
                                 break;
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 169750e..99c40a4 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -302,3 +302,4 @@ gre-heapoverflow-1	gre-heapoverflow-1.pcap	gre-heapoverflow-1.out	-t -v -n
 gre-heapoverflow-2	gre-heapoverflow-2.pcap	gre-heapoverflow-2.out	-t -v -n
 radiotap-heapoverflow	radiotap-heapoverflow.pcap	radiotap-heapoverflow.out -t -v -n
 isoclns-heapoverflow	isoclns-heapoverflow.pcap	isoclns-heapoverflow.out	-t -v -n
+tcp-auth-heapoverflow	tcp-auth-heapoverflow.pcap	tcp-auth-heapoverflow.out	-t -v -n
diff --git a/tests/tcp-auth-heapoverflow.out b/tests/tcp-auth-heapoverflow.out
new file mode 100644
index 0000000..ba11513
--- /dev/null
+++ b/tests/tcp-auth-heapoverflow.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [DF], proto TCP (6), length 12336, bad cksum 3030 (->29a8)!)
+    48.48.48.48.12336 > 48.48.48.48.12336: Flags [.U], seq 808464432:808476696, ack 808464432, win 12336, urg 12336, options [enhanced authkeyid 4830303030303030[|tcp]
diff --git a/tests/tcp-auth-heapoverflow.pcap b/tests/tcp-auth-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..0d6fa1d549dd1f9317e9943feac34fa65725277b
GIT binary patch
literal 138
zcmca|c+)}yB;dfnz`)4B02fID^5GmPgM+~p%yM8bU_+OK@b5r{MMSa7V-p1cc{Cb^

literal 0
HcmV?d00001

-- 
1.7.9.5

