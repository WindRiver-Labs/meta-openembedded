From cb696b8e91d9860dd30ec3b7dcb16424cd6e18ac Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 17:32:38 -0700
Subject: [PATCH] CVE-2016-7936/Add a bounds check.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-udp.c                        |    5 +++++
 tests/TESTLIST                     |    1 +
 tests/udp-length-heapoverflow.out  |    2 ++
 tests/udp-length-heapoverflow.pcap |  Bin 0 -> 329 bytes
 4 files changed, 8 insertions(+)
 create mode 100644 tests/udp-length-heapoverflow.out
 create mode 100644 tests/udp-length-heapoverflow.pcap

diff --git a/print-udp.c b/print-udp.c
index 4b5cd7c..768f4be 100644
--- a/print-udp.c
+++ b/print-udp.c
@@ -376,6 +376,11 @@ udp_print(netdissect_options *ndo, register const u_char *bp, u_int length,
 	sport = EXTRACT_16BITS(&up->uh_sport);
 	dport = EXTRACT_16BITS(&up->uh_dport);
 
+	if (!ND_TTEST(up->uh_ulen)) {
+		udpipaddr_print(ndo, ip, sport, dport);
+		ND_PRINT((ndo, "[|udp]"));
+		return;
+	}
 	if (length < sizeof(struct udphdr)) {
 		udpipaddr_print(ndo, ip, sport, dport);
 		ND_PRINT((ndo, "truncated-udp %d", length));
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 6e4219e..0442e23 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -307,3 +307,4 @@ atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
 tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
 ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
 llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
+udp-length-heapoverflow	udp-length-heapoverflow.pcap	udp-length-heapoverflow.out	-t -v -n
diff --git a/tests/udp-length-heapoverflow.out b/tests/udp-length-heapoverflow.out
new file mode 100644
index 0000000..16dbdc9
--- /dev/null
+++ b/tests/udp-length-heapoverflow.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto UDP (17), length 12336, bad cksum 3030 (->699d)!)
+    48.48.48.48.12336 > 48.48.48.48.12336: [|udp]
diff --git a/tests/udp-length-heapoverflow.pcap b/tests/udp-length-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..5d4be386cc12d040ef6861541e647d93e84208b5
GIT binary patch
literal 329
ocmca|c+)}yB%sE?z`)4B02fh2=0HU`7+k?DpfW+Y!jaAZ0H9AjQUCw|

literal 0
HcmV?d00001

-- 
1.7.9.5

