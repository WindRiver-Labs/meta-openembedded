From 4ef024c8e94459e3ab9afae90e1948406e1d04db Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 11:24:37 -0700
Subject: [PATCH] CVE-2016-7992/When comparing against an LLC+SNAP header,
 check only the bytes we have.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno Böck.

Fix a length value to be unsigned while we're at it.
---
 print-cip.c                |   22 +++++++++++++---------
 tests/TESTLIST             |    1 +
 tests/heap-overflow-2.out  |    1 +
 tests/heap-overflow-2.pcap |  Bin 0 -> 88 bytes
 4 files changed, 15 insertions(+), 9 deletions(-)
 create mode 100644 tests/heap-overflow-2.out
 create mode 100644 tests/heap-overflow-2.pcap

diff --git a/print-cip.c b/print-cip.c
index ea8adf6..a123b69 100644
--- a/print-cip.c
+++ b/print-cip.c
@@ -32,8 +32,6 @@
 #include "interface.h"
 #include "addrtoname.h"
 
-#define RFC1483LLC_LEN	8
-
 static const unsigned char rfcllc[] = {
 	0xaa,	/* DSAP: non-ISO */
 	0xaa,	/* SSAP: non-ISO */
@@ -43,12 +41,12 @@ static const unsigned char rfcllc[] = {
 	0x00 };
 
 static inline void
-cip_print(netdissect_options *ndo, int length)
+cip_print(netdissect_options *ndo, u_int length)
 {
 	/*
 	 * There is no MAC-layer header, so just print the length.
 	 */
-	ND_PRINT((ndo, "%d: ", length));
+	ND_PRINT((ndo, "%u: ", length));
 }
 
 /*
@@ -62,17 +60,23 @@ cip_if_print(netdissect_options *ndo, const struct pcap_pkthdr *h, const u_char
 {
 	u_int caplen = h->caplen;
 	u_int length = h->len;
+	size_t cmplen;
 	u_short extracted_ethertype;
 
-	if (memcmp(rfcllc, p, sizeof(rfcllc))==0 && caplen < RFC1483LLC_LEN) {
-		ND_PRINT((ndo, "[|cip]"));
-		return (0);
-	}
+	cmplen = sizeof(rfcllc);
+	if (cmplen > caplen)
+		cmplen = caplen;
+	if (cmplen > length)
+		cmplen = length;
 
 	if (ndo->ndo_eflag)
 		cip_print(ndo, length);
 
-	if (memcmp(rfcllc, p, sizeof(rfcllc)) == 0) {
+	if (cmplen == 0) {
+		ND_PRINT((ndo, "[|cip]"));
+		return 0;
+	}
+	if (memcmp(rfcllc, p, cmplen) == 0) {
 		/*
 		 * LLC header is present.  Try to print it & higher layers.
 		 */
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 9106899..3eb0b56 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -292,3 +292,4 @@ cve2015-0261_02    cve2015-0261-crash.pcap      cve2015-0261-crash.out -t -v
 
 # bad packets from Hanno Böck
 heap-overflow-1	heap-overflow-1.pcap		heap-overflow-1.out	-t -v -n
+heap-overflow-2	heap-overflow-2.pcap		heap-overflow-2.out	-t -v -n
diff --git a/tests/heap-overflow-2.out b/tests/heap-overflow-2.out
new file mode 100644
index 0000000..d2fd93f
--- /dev/null
+++ b/tests/heap-overflow-2.out
@@ -0,0 +1 @@
+IP3 [|ip]
diff --git a/tests/heap-overflow-2.pcap b/tests/heap-overflow-2.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..7770b954030431fa0042d85e1c22aea974787699
GIT binary patch
literal 88
ccmca|c+)}yB*4hPz#z=PfDi%l5gg)K04A>x-v9sr

literal 0
HcmV?d00001

-- 
1.7.9.5

