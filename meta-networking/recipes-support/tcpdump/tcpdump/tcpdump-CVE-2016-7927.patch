From da946bdc6c4a6f8adaaef67f93d95f499a9cb145 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 16:01:36 -0700
Subject: [PATCH] CVE-2016-7927/Do bounds checking on last_presentp before
 dereferencing it.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-802_11.c                   |    9 ++++++---
 tests/TESTLIST                   |    1 +
 tests/radiotap-heapoverflow.out  |    1 +
 tests/radiotap-heapoverflow.pcap |  Bin 0 -> 296 bytes
 4 files changed, 8 insertions(+), 3 deletions(-)
 create mode 100644 tests/radiotap-heapoverflow.out
 create mode 100644 tests/radiotap-heapoverflow.pcap

diff --git a/print-802_11.c b/print-802_11.c
index 78a57b1..1bbe47a 100644
--- a/print-802_11.c
+++ b/print-802_11.c
@@ -2850,6 +2850,9 @@ ieee802_11_radio_print(netdissect_options *ndo,
 
 	len = EXTRACT_LE_16BITS(&hdr->it_len);
 
+	/*
+	 * If we don't have the entire radiotap header, just give up.
+	 */
 	if (caplen < len) {
 		ND_PRINT((ndo, "%s", tstr));
 		return caplen;
@@ -2857,13 +2860,13 @@ ieee802_11_radio_print(netdissect_options *ndo,
 	cpack_init(&cpacker, (uint8_t *)hdr, len); /* align against header start */
 	cpack_advance(&cpacker, sizeof(*hdr)); /* includes the 1st bitmap */
 	for (last_presentp = &hdr->it_present;
-	     IS_EXTENDED(last_presentp) &&
-	     (u_char*)(last_presentp + 1) <= p + len;
+	     (const u_char*)(last_presentp + 1) <= p + len &&
+	     IS_EXTENDED(last_presentp);
 	     last_presentp++)
 	  cpack_advance(&cpacker, sizeof(hdr->it_present)); /* more bitmaps */
 
 	/* are there more bitmap extensions than bytes in header? */
-	if (IS_EXTENDED(last_presentp)) {
+	if ((const u_char*)(last_presentp + 1) > p + len) {
 		ND_PRINT((ndo, "%s", tstr));
 		return caplen;
 	}
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 96d0312..1bcd7b3 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -300,3 +300,4 @@ heapoverflow-ip_print_demux	heapoverflow-ip_print_demux.pcap	heapoverflow-ip_pri
 heapoverflow-tcp_print	heapoverflow-tcp_print.pcap	heapoverflow-tcp_print.out	-t -v -n
 gre-heapoverflow-1	gre-heapoverflow-1.pcap	gre-heapoverflow-1.out	-t -v -n
 gre-heapoverflow-2	gre-heapoverflow-2.pcap	gre-heapoverflow-2.out	-t -v -n
+radiotap-heapoverflow	radiotap-heapoverflow.pcap	radiotap-heapoverflow.out -t -v -n
diff --git a/tests/radiotap-heapoverflow.out b/tests/radiotap-heapoverflow.out
new file mode 100644
index 0000000..a81d184
--- /dev/null
+++ b/tests/radiotap-heapoverflow.out
@@ -0,0 +1 @@
+[|802.11]
diff --git a/tests/radiotap-heapoverflow.pcap b/tests/radiotap-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..af182b2b8332f6ddf3af73b67cd5aeb3ef24ec63
GIT binary patch
literal 296
jcmca|c+)}yB*4MIz);V?02g6kgmE}Pg1_JrBa8t6f*LrL

literal 0
HcmV?d00001

-- 
1.7.9.5

