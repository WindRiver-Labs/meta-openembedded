From 69ead2a09cf7d0666c6a7ac12e47fd9743242c61 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 18:07:35 -0700
Subject: [PATCH] CVE-2016-7931/Add bounds and length checks.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-mpls.c                       |   10 ++++++++++
 tests/TESTLIST                     |    1 +
 tests/mpls-label-heapoverflow.out  |    2 ++
 tests/mpls-label-heapoverflow.pcap |  Bin 0 -> 329 bytes
 4 files changed, 13 insertions(+)
 create mode 100644 tests/mpls-label-heapoverflow.out
 create mode 100644 tests/mpls-label-heapoverflow.pcap

diff --git a/print-mpls.c b/print-mpls.c
index 6d0539e..f6ee434 100644
--- a/print-mpls.c
+++ b/print-mpls.c
@@ -67,6 +67,10 @@ mpls_print(netdissect_options *ndo, const u_char *bp, u_int length)
 	ND_PRINT((ndo, "MPLS"));
 	do {
 		ND_TCHECK2(*p, sizeof(label_entry));
+		if (length < sizeof(label_entry)) {
+			ND_PRINT((ndo, "[|MPLS], length %u", length));
+			return;
+		}
 		label_entry = EXTRACT_32BITS(p);
 		ND_PRINT((ndo, "%s(label %u",
 		       (label_stack_depth && ndo->ndo_vflag) ? "\n\t" : " ",
@@ -81,6 +85,7 @@ mpls_print(netdissect_options *ndo, const u_char *bp, u_int length)
 		ND_PRINT((ndo, ", ttl %u)", MPLS_TTL(label_entry)));
 
 		p += sizeof(label_entry);
+		length -= sizeof(label_entry);
 	} while (!MPLS_STACK(label_entry));
 
 	/*
@@ -123,6 +128,11 @@ mpls_print(netdissect_options *ndo, const u_char *bp, u_int length)
 		 * Cisco sends control-plane traffic MPLS-encapsulated in
 		 * this fashion.
 		 */
+		ND_TCHECK(*p);
+		if (length < 1) {
+			/* nothing to print */
+			return;
+		}
 		switch(*p) {
 
 		case 0x45:
diff --git a/tests/TESTLIST b/tests/TESTLIST
index e601f59..d9751c9 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -310,3 +310,4 @@ llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
 udp-length-heapoverflow	udp-length-heapoverflow.pcap	udp-length-heapoverflow.out	-t -v -n
 aarp-heapoverflow-1	aarp-heapoverflow-1.pcap	aarp-heapoverflow-1.out	-t -v -n
 aarp-heapoverflow-2	aarp-heapoverflow-2.pcap	aarp-heapoverflow-2.out	-t -v -n
+mpls-label-heapoverflow	mpls-label-heapoverflow.pcap	mpls-label-heapoverflow.out	-t -v -n
diff --git a/tests/mpls-label-heapoverflow.out b/tests/mpls-label-heapoverflow.out
new file mode 100644
index 0000000..1419cac
--- /dev/null
+++ b/tests/mpls-label-heapoverflow.out
@@ -0,0 +1,2 @@
+MPLS (label 197379, exp 0, ttl 48)
+	(label 197387, exp 5, [S], ttl 48)[|MPLS]
diff --git a/tests/mpls-label-heapoverflow.pcap b/tests/mpls-label-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..bafba4ffd3f24d2552af0dfe5a633690c3072b78
GIT binary patch
literal 329
lcmca|c+)}yBp}AXz`)4B02fh2=0HU|JRpqSa8;uW0{~@XKK}p!

literal 0
HcmV?d00001

-- 
1.7.9.5

