From f6ae2501feb6aa4d54f39d4df6355bd6bcfa34d3 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 11:55:29 -0700
Subject: [PATCH] CVE-2016-7933/Add some bounds checks.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-ppp.c                               |    5 +++++
 tests/TESTLIST                            |    1 +
 tests/heapoverflow-ppp_hdlc_if_print.out  |    1 +
 tests/heapoverflow-ppp_hdlc_if_print.pcap |  Bin 0 -> 88 bytes
 4 files changed, 7 insertions(+)
 create mode 100644 tests/heapoverflow-ppp_hdlc_if_print.out
 create mode 100644 tests/heapoverflow-ppp_hdlc_if_print.pcap

diff --git a/print-ppp.c b/print-ppp.c
index ba5352b..ee8239c 100644
--- a/print-ppp.c
+++ b/print-ppp.c
@@ -1670,6 +1670,11 @@ ppp_hdlc_if_print(netdissect_options *ndo,
 		return (chdlc_if_print(ndo, h, p));
 
 	default:
+		if (caplen < 4) {
+			ND_PRINT((ndo, "[|ppp]"));
+			return (caplen);
+		}
+
 		if (ndo->ndo_eflag)
 			ND_PRINT((ndo, "%02x %02x %d ", p[0], p[1], length));
 		p += 2;
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 3104258..4f13b62 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -294,3 +294,4 @@ cve2015-0261_02    cve2015-0261-crash.pcap      cve2015-0261-crash.out -t -v
 heap-overflow-1	heap-overflow-1.pcap		heap-overflow-1.out	-t -v -n
 heap-overflow-2	heap-overflow-2.pcap		heap-overflow-2.out	-t -v -n
 heapoverflow-atalk_print	heapoverflow-atalk_print.pcap	heapoverflow-atalk_print.out	-t -v -n
+heapoverflow-ppp_hdlc_if_print	heapoverflow-ppp_hdlc_if_print.pcap	heapoverflow-ppp_hdlc_if_print.out	-t -v -n
diff --git a/tests/heapoverflow-ppp_hdlc_if_print.out b/tests/heapoverflow-ppp_hdlc_if_print.out
new file mode 100644
index 0000000..39cef42
--- /dev/null
+++ b/tests/heapoverflow-ppp_hdlc_if_print.out
@@ -0,0 +1 @@
+[|ppp]
diff --git a/tests/heapoverflow-ppp_hdlc_if_print.pcap b/tests/heapoverflow-ppp_hdlc_if_print.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..769a6059b800bd08a4b03b095d451b58e8adf735
GIT binary patch
literal 88
ccmca|c+)}yB*4VLz+l9{fDi%l5gg)K053BT{{R30

literal 0
HcmV?d00001

-- 
1.7.9.5

