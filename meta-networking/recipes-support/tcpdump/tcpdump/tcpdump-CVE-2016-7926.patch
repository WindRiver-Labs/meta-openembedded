From 8be5413f3a168bd9913ac7ab348404f5af54dd42 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 16:21:08 -0700
Subject: [PATCH] CVE-2016-7926/Do some additional bounds checking before
 calling isoclns_print().
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-ether.c                   |    6 +++++-
 tests/TESTLIST                  |    1 +
 tests/isoclns-heapoverflow.out  |    1 +
 tests/isoclns-heapoverflow.pcap |  Bin 0 -> 329 bytes
 4 files changed, 7 insertions(+), 1 deletion(-)
 create mode 100644 tests/isoclns-heapoverflow.out
 create mode 100644 tests/isoclns-heapoverflow.pcap

diff --git a/print-ether.c b/print-ether.c
index 59d15c2..5072c44 100644
--- a/print-ether.c
+++ b/print-ether.c
@@ -352,7 +352,11 @@ ethertype_print(netdissect_options *ndo,
 		return (1);
 
 	case ETHERTYPE_ISO:
-		isoclns_print(ndo, p + 1, length - 1, length - 1);
+		if (length == 0 || caplen == 0) {
+			ND_PRINT((ndo, " [|osi]"));
+			return (1);
+		}
+		isoclns_print(ndo, p + 1, length - 1, caplen - 1);
 		return(1);
 
 	case ETHERTYPE_PPPOED:
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 1bcd7b3..169750e 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -301,3 +301,4 @@ heapoverflow-tcp_print	heapoverflow-tcp_print.pcap	heapoverflow-tcp_print.out	-t
 gre-heapoverflow-1	gre-heapoverflow-1.pcap	gre-heapoverflow-1.out	-t -v -n
 gre-heapoverflow-2	gre-heapoverflow-2.pcap	gre-heapoverflow-2.out	-t -v -n
 radiotap-heapoverflow	radiotap-heapoverflow.pcap	radiotap-heapoverflow.out -t -v -n
+isoclns-heapoverflow	isoclns-heapoverflow.pcap	isoclns-heapoverflow.out	-t -v -n
diff --git a/tests/isoclns-heapoverflow.out b/tests/isoclns-heapoverflow.out
new file mode 100644
index 0000000..c2cfdfb
--- /dev/null
+++ b/tests/isoclns-heapoverflow.out
@@ -0,0 +1 @@
+|OSI
diff --git a/tests/isoclns-heapoverflow.pcap b/tests/isoclns-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..6ddf66160932f5a3a1d8fa49bfb4cabed2b60bf4
GIT binary patch
literal 329
kcmca|c+)}yB*4$Wz`)4B02fh2=0HXN{ew%7GGHM901mo8nE(I)

literal 0
HcmV?d00001

-- 
1.7.9.5

