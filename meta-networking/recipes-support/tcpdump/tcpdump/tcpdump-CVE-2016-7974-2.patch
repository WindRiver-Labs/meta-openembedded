From 39988398861a5fe3f2a89d1f3ff55ad0f7be770b Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 12:26:18 -0700
Subject: [PATCH] CVE-2016-7974/Add an additional bounds check.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-ip.c                             |    4 ++++
 tests/TESTLIST                         |    1 +
 tests/heapoverflow-ip_print_demux.out  |    6 ++++++
 tests/heapoverflow-ip_print_demux.pcap |  Bin 0 -> 202 bytes
 4 files changed, 11 insertions(+)
 create mode 100644 tests/heapoverflow-ip_print_demux.out
 create mode 100644 tests/heapoverflow-ip_print_demux.pcap

diff --git a/print-ip.c b/print-ip.c
index f96ba55..cbcdab8 100644
--- a/print-ip.c
+++ b/print-ip.c
@@ -330,6 +330,10 @@ again:
 	switch (ipds->nh) {
 
 	case IPPROTO_AH:
+		if (!ND_TTEST(*ipds->cp)) {
+			ND_PRINT((ndo, "[|AH]"));
+			break;
+		}
 		ipds->nh = *ipds->cp;
 		ipds->advance = ah_print(ndo, ipds->cp);
 		if (ipds->advance <= 0)
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 241dc91..d4f4bac 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -296,3 +296,4 @@ heap-overflow-2	heap-overflow-2.pcap		heap-overflow-2.out	-t -v -n
 heapoverflow-atalk_print	heapoverflow-atalk_print.pcap	heapoverflow-atalk_print.out	-t -v -n
 heapoverflow-ppp_hdlc_if_print	heapoverflow-ppp_hdlc_if_print.pcap	heapoverflow-ppp_hdlc_if_print.out	-t -v -n
 heapoverflow-sl_if_print	heapoverflow-sl_if_print.pcap	heapoverflow-sl_if_print.out	-t -v -n
+heapoverflow-ip_print_demux	heapoverflow-ip_print_demux.pcap	heapoverflow-ip_print_demux.out	-t -v -n
diff --git a/tests/heapoverflow-ip_print_demux.out b/tests/heapoverflow-ip_print_demux.out
new file mode 100644
index 0000000..af4a46d
--- /dev/null
+++ b/tests/heapoverflow-ip_print_demux.out
@@ -0,0 +1,6 @@
+30:30:30:30:30:30 > 30:30:30:30:30:30, ethertype Unknown (0x3030), length 808464432: 
+	0x0000:  3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+	0x0010:  3030 3030 3030 3030 3030 3030 3030 3030  0000000000000000
+	0x0020:  3030                                     00
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto AH (51), length 12336, bad cksum 3030 (->697b)!)
+    48.48.48.48 > 48.48.48.48: AH(spi=0x30303030,sumlen=192,seq=0x30303030[truncated]): [|AH]
diff --git a/tests/heapoverflow-ip_print_demux.pcap b/tests/heapoverflow-ip_print_demux.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..c3ad2adb04f76f40f3f49dbc2f4003dfad55039e
GIT binary patch
literal 202
tcmca|c+)}yWWd0{z{tP=7fAy0;T-xfu-M4K;0m@I=oVvyBaoOtK>&QNC1C&n

literal 0
HcmV?d00001

-- 
1.7.9.5

