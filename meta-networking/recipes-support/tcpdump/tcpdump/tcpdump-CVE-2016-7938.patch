From 5a8f78fef0c4a185e78df5c16c7daba099040468 Mon Sep 17 00:00:00 2001
From: Denis Ovsienko <denis@ovsienko.info>
Date: Sat, 31 Oct 2015 22:40:33 +0000
Subject: [PATCH] CVE-2016-7938/ZeroMQ: fix an infinite loop

This issue was discovered through fuzzing by Francois-Xavier Le Bail.
---
 print-zeromq.c |   11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/print-zeromq.c b/print-zeromq.c
index e07f8c6..a23d98a 100644
--- a/print-zeromq.c
+++ b/print-zeromq.c
@@ -125,8 +125,15 @@ zmtp1_print_frame(netdissect_options *ndo, const u_char *cp, const u_char *ep)
 		}
 	}
 
-	ND_TCHECK2(*cp, header_len + body_len_declared); /* Next frame within the buffer ? */
-	return cp + header_len + body_len_declared;
+	/*
+	 * Do not advance cp by the sum of header_len and body_len_declared
+	 * before each offset has successfully passed ND_TCHECK2() as the
+	 * sum can roll over (9 + 0xfffffffffffffff7 = 0) and cause an
+	 * infinite loop.
+	 */
+	cp += header_len;
+	ND_TCHECK2(*cp, body_len_declared); /* Next frame within the buffer ? */
+	return cp + body_len_declared;
 
 trunc:
 	ND_PRINT((ndo, "%s", tstr));
-- 
1.7.9.5

