From c39c1d99ac3b6d5d9519b39da6717180651650d3 Mon Sep 17 00:00:00 2001
From: Denis Ovsienko <denis@ovsienko.info>
Date: Thu, 12 Jan 2017 10:09:34 +0000
Subject: [PATCH] CVE-2017-5482/Q.933: add a missing bounds check

Brian Carpenter had found that regardless of CVE-2016-8575 q933_print()
still could overread the buffer trying to parse a short packet. This
change fixes the problem.
---
 print-fr.c                     |    1 +
 tests/TESTLIST                 |    1 +
 tests/q933-heapoverflow-2.out  |   24 ++++++++++++++++++++++++
 tests/q933-heapoverflow-2.pcap |  Bin 0 -> 1483 bytes
 4 files changed, 26 insertions(+)
 create mode 100644 tests/q933-heapoverflow-2.out
 create mode 100644 tests/q933-heapoverflow-2.pcap

diff --git a/print-fr.c b/print-fr.c
index f400ddc..da7ee25 100644
--- a/print-fr.c
+++ b/print-fr.c
@@ -791,6 +791,8 @@ q933_print(netdissect_options *ndo,
 
         ND_PRINT((ndo, "%s", ndo->ndo_eflag ? "" : "Q.933, "));
 
+	ND_TCHECK(p[0]);
+
 	/* printing out header part */
 	ND_PRINT((ndo, "%s, codeset %u", is_ansi ? "ANSI" : "CCITT", codeset));
 
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 5046046..91c3b8a 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -326,6 +326,7 @@ ipv6hdr-heapoverflow	ipv6hdr-heapoverflow.pcap	ipv6hdr-heapoverflow.out	-t
 ipv6hdr-heapoverflow-v	ipv6hdr-heapoverflow.pcap	ipv6hdr-heapoverflow-v.out	-t -v
 otv-heapoverflow-1	otv-heapoverflow-1.pcap		otv-heapoverflow-1.out		-t -c10
 otv-heapoverflow-2	otv-heapoverflow-2.pcap		otv-heapoverflow-2.out		-t -c10
+q933-heapoverflow-2	q933-heapoverflow-2.pcap	q933-heapoverflow-2.out		-t
 
 # RTP tests
 # fuzzed pcap
diff --git a/tests/q933-heapoverflow-2.out b/tests/q933-heapoverflow-2.out
new file mode 100644
index 0000000..1a40c73
--- /dev/null
+++ b/tests/q933-heapoverflow-2.out
@@ -0,0 +1,24 @@
+Q.922, invalid address
+UI 00! Q.922, hdr-len 4, DLCI 5769024, Flags [none], NLPID unknown (0x11), length 41: 
+	0x0000:  886b 68                                  .kh
+Q.922, invalid address
+UI 00! Q.922, hdr-len 4, DLCI 5769024, Flags [none], NLPID unknown (0x14), length 160: 
+	0x0000:  a530 b0                                  .0.
+Q.922, invalid address
+UI 00! Q.922, hdr-len 4, DLCI 5801792, Flags [none], NLPID unknown (0x11), length 179: 
+	0x0000:  886b 68                                  .kh
+Q.922, invalid address
+UI 00! Q.922, hdr-len 4, DLCI 5769024, Flags [none], NLPID unknown (0x14), length 30: 
+	0x0000:  a530 b0                                  .0.
+Q.922, invalid address
+UI 00! Q.922, hdr-len 4, DLCI 1856, Flags [none], NLPID unknown (0x11), length 85: 
+	0x0000:  886b 68                                  .kh
+Q.922, invalid address
+Q.922, invalid address
+UI 00! Q.922, hdr-len 4, DLCI 526144, Flags [none], NLPID unknown (0x14), length 46: 
+	0x0000:  a530 b0                                  .0.
+Q.922, invalid address
+UI 2c! Pad! Q.922, hdr-len 2, DLCI 288, Flags [none], NLPID NULL (0x00), length 24: 
+	0x0000:  1188 6b68                                ..kh
+Q.922, invalid address
+UI 2c! Pad! Q.933, CCITT, codeset 0[|q.933]
diff --git a/tests/q933-heapoverflow-2.pcap b/tests/q933-heapoverflow-2.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..c38c7b6f884339e50d2b0a61426d1902df3b29a9
GIT binary patch
literal 1483
zcmca|c+)~A1{MYw-~=+VftX+QyX$3h9)>U=8-yEx_&*ph2zF#=7(mDkVT})6)PPb9
zFPH^c7<gP<{lZ*>{N3C<on09@np(Q2@kkhWFf%f;vM?|)FtD?Q1}iXfOKUMQ7_kVc
zB;<f>`R>ohpb0bqgf}o)F+$B3S!%FhJ%qi0iIIU3D0`QaK|q3uK>)}EY4i-_W8ea^
zLHG&~Gk~>#WEO?<F)RQIfH2rdB*P#^9tdLuIfy}^;mYcbVqdo%J1=+Kd+Jh)d9@}o
zhi_Er&!3teC@wX<lVz3jw2Tdt4hB0&HvboUBon>lE#t{b)=AyTzk)bcIOf}`NgrLa
zR<u(l&9;~~Q=q)BaUbI=&Hod=PI#T_xwP}Zt_^EiYS*v?_&+_kSZ;w$L}cbFZSnMm
zx6^LltNgpw%ibst<lfm4Xg&c4F-WE;o{wQO(48Q>!2w&~Y+&N~K9Av#ke{4)XvagP
z&k^6lc19!$$sPCey)e^6=KafuOWeX#b_U*lcW1$}2i!v8=Aj;4&)iERt}Zb;7wa-l
z>g4SIv8Oow#A7lUPCqfTymiaVKC!X=*OVg-v)Ib&ZHx|dACh&Ld2(6x{I^T@7Z*18
zFJB_=r~P2dku#0=0#1a69*tdD7c}E7^YpyNifub&o*a00Wkt*s|4R;YRfRxa$WB1>
z96Xw|viTU~fF1*3?9p@q7)_wG2{LCv4w^aeK;kLjV+aMR0$~QMDd+%`Aqy~>U`d}U
z1|B(zOdP^0OpJU+EIdLI33u5T9HuccqNlc|LNx2)-Z)y##}ERv7=$^TFtbUz#)Giu
z!1Via-<I#(dwH^E^~kF3>M=bV88z|G^sDMsvp3F{m;BevzI?CMzh7sprkwq!`R(+{
zsufRHeK<Es^2=9{=S}PQ81#VVgRlU|ix?^TLl`gvGB6%MWIIF_TV0Rlc5u)M0L`7S
zhLb@8XeJ1IFzPU1X1)tdAa$RB>M-*fNJf1vCqo_3cOcB+sKdYkG<${t#C?zg;{lU6
zFohawyz-E*fA~wrbjAB<hEv>syafwRF1F9hT^ZrWu(B<Bc8i&}>qgfZn>lazysUU}
zO5J0Izf#~A#bYy82yK{l`%{ib_=|VX4PsYrICR|Y==bB5CL*bK?u7h!9+sZ8Bwnh2
z)`pAxHxC_Jteg3L+45~Nt?FT}NkN|(w_cf8-nVsbwRTy;o@bvgu}w0IX0V^t<+$qQ
zRHKZW)7h>6T-Ntmlffn%s?T|T$}`3LD|<6%RcXwMzu0B<X6|gR(>!ymxGMB^PyMUy
zogfvxz%tnX&9*w>U(yp!&E|djrB_}1Vd=UnIlS+Sb25V+ZH{FpMBRuL{(s@BcT&rW
zD_1V@6jVMl_2kquwBlHrX!!T<w3nVUc5H9kI_0<O%D}&UUtekdZjX;T*CO=(c7#dT
z33JuZkO{}r7b=~&WG&3@WH6`W?b?;ycV4gfquaUXAM=C`PQGtajXCEzj|n*LKQPB9
R`vY$s`?bh#%fG&A1^~Kd8Q1^-

literal 0
HcmV?d00001

-- 
1.7.9.5

