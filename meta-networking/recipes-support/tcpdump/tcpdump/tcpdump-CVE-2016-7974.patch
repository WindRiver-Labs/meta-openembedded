From 98f666f243759373773f08f8a91d42cc6f8c3e50 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 11:19:17 -0700
Subject: [PATCH] CVE-2016-7974/Check before fetching the IP protocol version.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno Böck.
---
 print-ip.c                 |   26 +++++++++++++++-----------
 tests/TESTLIST             |    3 +++
 tests/heap-overflow-1.out  |    1 +
 tests/heap-overflow-1.pcap |  Bin 0 -> 88 bytes
 4 files changed, 19 insertions(+), 11 deletions(-)
 create mode 100644 tests/heap-overflow-1.out
 create mode 100644 tests/heap-overflow-1.pcap

diff --git a/print-ip.c b/print-ip.c
index 69e621d..f96ba55 100644
--- a/print-ip.c
+++ b/print-ip.c
@@ -681,24 +681,28 @@ trunc:
 void
 ipN_print(netdissect_options *ndo, register const u_char *bp, register u_int length)
 {
-	struct ip hdr;
-
-	if (length < 4) {
+	if (length < 1) {
 		ND_PRINT((ndo, "truncated-ip %d", length));
 		return;
 	}
-	memcpy (&hdr, bp, 4);
-	switch (IP_V(&hdr)) {
-	case 4:
+
+	ND_TCHECK(*bp);
+	switch (*bp & 0xF0) {
+	case 0x40:
 		ip_print (ndo, bp, length);
-		return;
-	case 6:
+		break;
+	case 0x60:
 		ip6_print (ndo, bp, length);
-		return;
+		break;
 	default:
-		ND_PRINT((ndo, "unknown ip %d", IP_V(&hdr)));
-		return;
+		ND_PRINT((ndo, "unknown ip %d", (*bp & 0xF0) >> 4));
+		break;
 	}
+	return;
+
+trunc:
+	ND_PRINT((ndo, "%s", tstr));
+	return;
 }
 
 /*
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 890f4a9..9106899 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -289,3 +289,6 @@ kday8           kday8.pcap              kday8.out       -t -v
 # bad packets from reversex86.
 cve2015-0261_01    cve2015-0261-ipv6.pcap       cve2015-0261-ipv6.out -t -v
 cve2015-0261_02    cve2015-0261-crash.pcap      cve2015-0261-crash.out -t -v
+
+# bad packets from Hanno Böck
+heap-overflow-1	heap-overflow-1.pcap		heap-overflow-1.out	-t -v -n
diff --git a/tests/heap-overflow-1.out b/tests/heap-overflow-1.out
new file mode 100644
index 0000000..4d2862d
--- /dev/null
+++ b/tests/heap-overflow-1.out
@@ -0,0 +1 @@
+unknown ip 3
diff --git a/tests/heap-overflow-1.pcap b/tests/heap-overflow-1.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..ada5c78b9557f8a59dfa494d199e025880d115e6
GIT binary patch
literal 88
ccmca|c+)}yB*4hPz`(=6fDi%l5gg)K03_28*Z=?k

literal 0
HcmV?d00001

-- 
1.7.9.5

