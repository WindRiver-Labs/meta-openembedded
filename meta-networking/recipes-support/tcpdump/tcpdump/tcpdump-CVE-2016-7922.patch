From e57b260be429af93d6217c8e79a2f863551332bf Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 13:20:28 -0700
Subject: [PATCH] CVE-2016-7922/Report to our caller that dissection failed if
 a bounds check fails.

That way, our caller doesn't keep dissecting.
---
 print-ah.c |    6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/print-ah.c b/print-ah.c
index 26bc43e..a23abb4 100644
--- a/print-ah.c
+++ b/print-ah.c
@@ -53,8 +53,10 @@ ah_print(netdissect_options *ndo, register const u_char *bp)
 	if (ndo->ndo_vflag)
 		ND_PRINT((ndo, ",sumlen=%d", sumlen));
 	ND_PRINT((ndo, ",seq=0x%x", EXTRACT_32BITS(ah + 1)));
-	if (bp + sizeof(struct ah) + sumlen > ep)
-		ND_PRINT((ndo, "[truncated]"));
+	if (!ND_TTEST2(*bp, sizeof(struct ah) + sumlen)) {
+		ND_PRINT((ndo, "[truncated]):"));
+		return -1;
+	}
 	ND_PRINT((ndo, "): "));
 
 	return sizeof(struct ah) + sumlen;
-- 
1.7.9.5

