From 409ffe94529df3d8bb8258bf99586f821756cb29 Mon Sep 17 00:00:00 2001
From: Denis Ovsienko <denis@ovsienko.info>
Date: Tue, 10 Jan 2017 10:39:35 +0000
Subject: [PATCH] CVE-2017-5341/OTV: add missing bounds checks

Interleave the bounds checking with printing to make it visible which
last protocol field was OK. This fixes a vulnerability discovered by
Brian Carpenter.
---
 print-otv.c                   |   30 +++++++++++++++++-------------
 tests/TESTLIST                |    1 +
 tests/otv-heapoverflow-1.out  |   10 ++++++++++
 tests/otv-heapoverflow-1.pcap |  Bin 0 -> 896 bytes
 4 files changed, 28 insertions(+), 13 deletions(-)
 create mode 100644 tests/otv-heapoverflow-1.out
 create mode 100644 tests/otv-heapoverflow-1.pcap

diff --git a/print-otv.c b/print-otv.c
index 1b05107..f276441 100644
--- a/print-otv.c
+++ b/print-otv.c
@@ -39,27 +39,30 @@ void
 otv_print(netdissect_options *ndo, const u_char *bp, u_int len)
 {
     uint8_t flags;
-    uint32_t overlay_id;
-    uint32_t instance_id;
-
-    if (len < 8) {
-        ND_PRINT((ndo, "[|OTV]"));
-        return;
-    }
+    ND_PRINT((ndo, "OTV, "));
+    if (len < 8)
+        goto trunc;
 
+    ND_TCHECK(*bp);
     flags = *bp;
+    ND_PRINT((ndo, "flags [%s] (0x%02x), ", flags & 0x08 ? "I" : ".", flags));
     bp += 1;
 
-    overlay_id = EXTRACT_24BITS(bp);
+    ND_TCHECK2(*bp, 3);
+    ND_PRINT((ndo, "overlay %u, ", EXTRACT_24BITS(bp)));
     bp += 3;
 
-    instance_id = EXTRACT_24BITS(bp);
-    bp += 4;
+    ND_TCHECK2(*bp, 3);
+    ND_PRINT((ndo, "instance %u\n", EXTRACT_24BITS(bp)));
+    bp += 3;
 
-    ND_PRINT((ndo, "OTV, "));
-    ND_PRINT((ndo, "flags [%s] (0x%02x), ", flags & 0x08 ? "I" : ".", flags));
-    ND_PRINT((ndo, "overlay %u, ", overlay_id));
-    ND_PRINT((ndo, "instance %u\n", instance_id));
+    /* Reserved */
+    ND_TCHECK(*bp);
+    bp += 1;
 
     ether_print(ndo, bp, len - 8, len - 8, NULL, NULL);
+    return;
+
+trunc:
+    ND_PRINT((ndo, " [|OTV]"));
 }
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 266e093..379dae5 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -324,6 +324,7 @@ tftp-heapoverflow	tftp-heapoverflow.pcap	tftp-heapoverflow.out	-t -v -n
 # bad packets from Brian Carpenter
 ipv6hdr-heapoverflow	ipv6hdr-heapoverflow.pcap	ipv6hdr-heapoverflow.out	-t
 ipv6hdr-heapoverflow-v	ipv6hdr-heapoverflow.pcap	ipv6hdr-heapoverflow-v.out	-t -v
+otv-heapoverflow-1	otv-heapoverflow-1.pcap		otv-heapoverflow-1.out		-t -c10
 
 # RTP tests
 # fuzzed pcap
diff --git a/tests/otv-heapoverflow-1.out b/tests/otv-heapoverflow-1.out
new file mode 100644
index 0000000..4bef9dd
--- /dev/null
+++ b/tests/otv-heapoverflow-1.out
@@ -0,0 +1,10 @@
+IP 192.168.0.134.47808 > 192.168.0.24.47808: UDP, length 6
+IP 192.168.0.134.47808 > 192.168.0.24.47808: UDP, length 12
+IP 192.168.0.24.47808 > 192.168.0.134.47808: UDP, length 6
+IP 192.168.0.24.47808 > 192.168.0.255.47808: UDP, length 18
+IP 192.168.0.105.47808 > 192.168.0.255.47808: UDP, length 25
+IP 192.168.0.24.47808 > 192.168.0.134.47808: UDP, length 31
+IP 192.168.0.18.47808 > 192.168.0.255.47808: UDP, length 24
+IP 192.168.0.24.40896 > 192.168.0.134.47808: UDP, length 30
+IP 192.168.0.24.47808 > 192.168.0.255.47808: UDP, length 20
+IP 192.168.0.9.37123 > 97.34.1.224.8472: OTV, flags [I] (0x9d), overlay 12124160,  [|OTV]
diff --git a/tests/otv-heapoverflow-1.pcap b/tests/otv-heapoverflow-1.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..c5e16bf61060b3d83048104d3bd8bcf025741651
GIT binary patch
literal 896
zcmb7?O(+Cm9LAqvv1^%jw^d6%cK3i3EwOC~<s*v2<iL$Rii4AqY*x{7b0<kY%1ug^
z!xjh1cU+~!!AWUzQRDxA-|;ydy!F(~;rY$)Y2K^-&7~Ar@O~=jK>?n|V;NmN_t^;0
zI|sK%aIB!fw%6QeMJwPh>j5U5Kw=%!6i+-6Pe7edM$?e~*w6hK^@CL9nEIt<y}$I`
zBbiYfvJ|hbLv>i0^8A{OdIE6d_a#eOXvaXI^T@#lY$7dyD3H#D&%-Q>RsCS;;(TFM
zXeZ1%oHbawVC50Z0+(ce_1Yj-GvPS~%QqaU+7(_kKogpr+dB0ID3awHt&G}{Yfx~I
z0*v|74(3w*iiP!VI#hHJj$@iyr=1GDq@gFLmI%Ef{!BdaCm3BSCW*-ru6O7!N6xiy
zt<G2`Tj$djL3pQh^*+qZ+TjsM-633E!qw-((4e=od%#;6Y9!wO4^K^ws%WPw$27H8
zJNrI$k?&Tqm|Dn|#?&8P%nh%qXdooV^oIl5x!_I_gKvvmnonFi+zP}>TiCDM&ZYW1
nOk3Mj(LyAS$ug*22-*vgK3WlKE$jeoRN$B#LfWNhjY)?$*(3Zi

literal 0
HcmV?d00001

-- 
1.7.9.5

