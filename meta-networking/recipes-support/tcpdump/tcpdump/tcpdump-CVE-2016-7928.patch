From a36c495ef49f96d41cd39caa5283aa6c4c32fd8b Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 17:14:58 -0700
Subject: [PATCH] CVE-2016-7928/Check whether we have the CPI before we fetch
 it.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-ipcomp.c                 |   13 +++++--------
 tests/TESTLIST                 |    1 +
 tests/ipcomp-heapoverflow.out  |    2 ++
 tests/ipcomp-heapoverflow.pcap |  Bin 0 -> 329 bytes
 4 files changed, 8 insertions(+), 8 deletions(-)
 create mode 100644 tests/ipcomp-heapoverflow.out
 create mode 100644 tests/ipcomp-heapoverflow.pcap

diff --git a/print-ipcomp.c b/print-ipcomp.c
index 82469b3..354eef3 100644
--- a/print-ipcomp.c
+++ b/print-ipcomp.c
@@ -43,22 +43,15 @@ int
 ipcomp_print(netdissect_options *ndo, register const u_char *bp, int *nhdr _U_)
 {
 	register const struct ipcomp *ipcomp;
-	register const u_char *ep;
 	uint16_t cpi;
 #if defined(HAVE_LIBZ) && defined(HAVE_ZLIB_H)
 	int advance;
 #endif
 
 	ipcomp = (struct ipcomp *)bp;
+	ND_TCHECK(ipcomp->comp_cpi);
 	cpi = EXTRACT_16BITS(&ipcomp->comp_cpi);
 
-	/* 'ep' points to the end of available data. */
-	ep = ndo->ndo_snapend;
-
-	if ((u_char *)(ipcomp + 1) >= ep - sizeof(struct ipcomp)) {
-		ND_PRINT((ndo, "[|IPCOMP]"));
-		goto fail;
-	}
 	ND_PRINT((ndo, "IPComp(cpi=0x%04x)", cpi));
 
 #if defined(HAVE_LIBZ) && defined(HAVE_ZLIB_H)
@@ -78,6 +71,10 @@ ipcomp_print(netdissect_options *ndo, register const u_char *bp, int *nhdr _U_)
 	return advance;
 
 #endif
+trunc:
+	ND_PRINT((ndo, "[|IPCOMP]"));
+#if defined(HAVE_LIBZ) && defined(HAVE_ZLIB_H)
 fail:
+#endif
 	return -1;
 }
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 15c5010..c137e8d 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -305,3 +305,4 @@ isoclns-heapoverflow	isoclns-heapoverflow.pcap	isoclns-heapoverflow.out	-t -v -n
 tcp-auth-heapoverflow	tcp-auth-heapoverflow.pcap	tcp-auth-heapoverflow.out	-t -v -n
 atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
 tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
+ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
diff --git a/tests/ipcomp-heapoverflow.out b/tests/ipcomp-heapoverflow.out
new file mode 100644
index 0000000..c158cdf
--- /dev/null
+++ b/tests/ipcomp-heapoverflow.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto Compressed IP (108), length 12336, bad cksum 3030 (->6942)!)
+    48.48.48.48 > 48.48.48.48: [|IPCOMP]
diff --git a/tests/ipcomp-heapoverflow.pcap b/tests/ipcomp-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..dc2d17d161c3a4a82b92af93b04d7d9b49b74219
GIT binary patch
literal 329
ocmca|c+)}yB%s8=z`)4B02fh2=0HU`7+k?Dpt2me!jaAZ0QvbnsQ>@~

literal 0
HcmV?d00001

-- 
1.7.9.5

