From 3e00e6a4b8fd976f05f094bba2b2c7657985c7ae Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 12:37:37 -0700
Subject: [PATCH] CVE-2016-7975/Fix a bounds check.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-tcp.c                       |    2 +-
 tests/TESTLIST                    |    1 +
 tests/heapoverflow-tcp_print.out  |    2 ++
 tests/heapoverflow-tcp_print.pcap |  Bin 0 -> 112 bytes
 4 files changed, 4 insertions(+), 1 deletion(-)
 create mode 100644 tests/heapoverflow-tcp_print.out
 create mode 100644 tests/heapoverflow-tcp_print.pcap

diff --git a/print-tcp.c b/print-tcp.c
index 7a04a6f..a1c1dde 100644
--- a/print-tcp.c
+++ b/print-tcp.c
@@ -624,7 +624,7 @@ tcp_print(netdissect_options *ndo,
                                 if (datalen)
                                         ND_PRINT((ndo, " 0x"));
                                 for (i = 0; i < datalen; ++i) {
-                                        LENCHECK(i);
+                                        LENCHECK(i + 1);
                                         ND_PRINT((ndo, "%02x", cp[i]));
                                 }
                                 break;
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 170b1df..3bab6bb 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -297,3 +297,4 @@ heapoverflow-atalk_print	heapoverflow-atalk_print.pcap	heapoverflow-atalk_print.
 heapoverflow-ppp_hdlc_if_print	heapoverflow-ppp_hdlc_if_print.pcap	heapoverflow-ppp_hdlc_if_print.out	-t -v -n
 heapoverflow-sl_if_print	heapoverflow-sl_if_print.pcap	heapoverflow-sl_if_print.out	-t -v -n
 heapoverflow-ip_print_demux	heapoverflow-ip_print_demux.pcap	heapoverflow-ip_print_demux.out	-t -v -n
+heapoverflow-tcp_print	heapoverflow-tcp_print.pcap	heapoverflow-tcp_print.out	-t -v -n
diff --git a/tests/heapoverflow-tcp_print.out b/tests/heapoverflow-tcp_print.out
new file mode 100644
index 0000000..9d31674
--- /dev/null
+++ b/tests/heapoverflow-tcp_print.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [DF], proto TCP (6), length 12336, bad cksum 3030 (->29a8)!)
+    48.48.48.48.12336 > 48.48.48.48.12336: Flags [.U], seq 808464432:808476688, ack 808464432, win 12336, urg 12336, options [unknown-48 0x3030303030303030[|tcp]
diff --git a/tests/heapoverflow-tcp_print.pcap b/tests/heapoverflow-tcp_print.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..c8b43fdfcf68f596dc94d140ed1914ecd93ccff1
GIT binary patch
literal 112
xcmca|c+)}yB;dfnz`)4B02lE9^5GmPgM+~p%yM8bU_+OK@c+VuHDC-F4FCe)72E&-

literal 0
HcmV?d00001

-- 
1.7.9.5

