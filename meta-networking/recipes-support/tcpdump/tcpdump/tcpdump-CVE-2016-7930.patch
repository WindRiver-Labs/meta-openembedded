From 9845aa1860a411c40e5f86b74443508d58fc67f9 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 17:25:39 -0700
Subject: [PATCH] CVE-2016-7930/Add a bounds check.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-llc.c                     |    6 ++++++
 tests/TESTLIST                  |    1 +
 tests/llc-xid-heapoverflow.out  |    1 +
 tests/llc-xid-heapoverflow.pcap |  Bin 0 -> 329 bytes
 4 files changed, 8 insertions(+)
 create mode 100644 tests/llc-xid-heapoverflow.out
 create mode 100644 tests/llc-xid-heapoverflow.pcap

diff --git a/print-llc.c b/print-llc.c
index bca9b50..7f316c2 100644
--- a/print-llc.c
+++ b/print-llc.c
@@ -343,6 +343,12 @@ llc_print(netdissect_options *ndo, const u_char *p, u_int length, u_int caplen,
 		p += 3;
 
 		if ((control & ~LLC_U_POLL) == LLC_XID) {
+			if (caplen < 2 || length < 2) {
+				ND_PRINT((ndo, "[|llc]"));
+				if (caplen > 0)
+					ND_DEFAULTPRINT((const u_char *)p, caplen);
+				return (1);
+			}
 			if (*p == LLC_XID_FI) {
 				ND_PRINT((ndo, ": %02x %02x", p[1], p[2]));
 			}
diff --git a/tests/TESTLIST b/tests/TESTLIST
index c137e8d..6e4219e 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -306,3 +306,4 @@ tcp-auth-heapoverflow	tcp-auth-heapoverflow.pcap	tcp-auth-heapoverflow.out	-t -v
 atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
 tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
 ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
+llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
diff --git a/tests/llc-xid-heapoverflow.out b/tests/llc-xid-heapoverflow.out
new file mode 100644
index 0000000..4fcad70
--- /dev/null
+++ b/tests/llc-xid-heapoverflow.out
@@ -0,0 +1 @@
+Unknown DSAP 0x30 Unnumbered, xid, Flags [Poll], length 808464412[|llc]
diff --git a/tests/llc-xid-heapoverflow.pcap b/tests/llc-xid-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..0574501e5e8c02e0d8f84983801a0612016b5f70
GIT binary patch
literal 329
jcmca|c+)}yBp}Yfz`)JG02fhYMB>0jVT}DS#wZN{{GC3Y

literal 0
HcmV?d00001

-- 
1.7.9.5

