From c4744fc29aefea62ab751d50d5e4743c3065ef5f Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 12:05:26 -0700
Subject: [PATCH] CVE-2016-7925/Add more bounds checks.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-sl.c                          |    6 ++++++
 tests/TESTLIST                      |    1 +
 tests/heapoverflow-sl_if_print.out  |    1 +
 tests/heapoverflow-sl_if_print.pcap |  Bin 0 -> 88 bytes
 4 files changed, 8 insertions(+)
 create mode 100644 tests/heapoverflow-sl_if_print.out
 create mode 100644 tests/heapoverflow-sl_if_print.pcap

diff --git a/print-sl.c b/print-sl.c
index ec81608..3fd7e89 100644
--- a/print-sl.c
+++ b/print-sl.c
@@ -67,6 +67,7 @@ sl_if_print(netdissect_options *ndo,
 		return (caplen);
 	}
 
+	caplen -= SLIP_HDRLEN;
 	length -= SLIP_HDRLEN;
 
 	ip = (struct ip *)(p + SLIP_HDRLEN);
@@ -74,6 +75,11 @@ sl_if_print(netdissect_options *ndo,
 	if (ndo->ndo_eflag)
 		sliplink_print(ndo, p, ip, length);
 
+	if (caplen < 1 || length < 1) {
+		ND_PRINT((ndo, "%s", tstr));
+		return (caplen + SLIP_HDRLEN);
+	}
+
 	switch (IP_V(ip)) {
 	case 4:
 	        ip_print(ndo, (u_char *)ip, length);
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 4f13b62..241dc91 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -295,3 +295,4 @@ heap-overflow-1	heap-overflow-1.pcap		heap-overflow-1.out	-t -v -n
 heap-overflow-2	heap-overflow-2.pcap		heap-overflow-2.out	-t -v -n
 heapoverflow-atalk_print	heapoverflow-atalk_print.pcap	heapoverflow-atalk_print.out	-t -v -n
 heapoverflow-ppp_hdlc_if_print	heapoverflow-ppp_hdlc_if_print.pcap	heapoverflow-ppp_hdlc_if_print.out	-t -v -n
+heapoverflow-sl_if_print	heapoverflow-sl_if_print.pcap	heapoverflow-sl_if_print.out	-t -v -n
diff --git a/tests/heapoverflow-sl_if_print.out b/tests/heapoverflow-sl_if_print.out
new file mode 100644
index 0000000..4ddcf52
--- /dev/null
+++ b/tests/heapoverflow-sl_if_print.out
@@ -0,0 +1 @@
+[|slip]
diff --git a/tests/heapoverflow-sl_if_print.pcap b/tests/heapoverflow-sl_if_print.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..4541b1d4380ee148797d4523eaef27ba2e836145
GIT binary patch
literal 88
ccmca|c+)}yBp|@Rz`()4fDi%l5gg)K04Mtp;{X5v

literal 0
HcmV?d00001

-- 
1.7.9.5

