From 5e48a557542817a3bd6d344a1b96a3c9ad8ccfb8 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Mon, 13 Jul 2015 16:52:51 -0700
Subject: [PATCH] CVE-2016-7929/Make sure a Juniper header TLV isn't bigger
 than what's left in the packet.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-juniper.c                        |    6 ++++--
 tests/TESTLIST                         |    1 +
 tests/juniper_header-heapoverflow.out  |    1 +
 tests/juniper_header-heapoverflow.pcap |  Bin 0 -> 200 bytes
 4 files changed, 6 insertions(+), 2 deletions(-)
 create mode 100644 tests/juniper_header-heapoverflow.out
 create mode 100644 tests/juniper_header-heapoverflow.pcap

diff --git a/print-juniper.c b/print-juniper.c
index 4fb5453..83ac372 100644
--- a/print-juniper.c
+++ b/print-juniper.c
@@ -89,7 +89,7 @@ enum {
 };
 
 /* 1 byte type and 1-byte length */
-#define JUNIPER_EXT_TLV_OVERHEAD 2
+#define JUNIPER_EXT_TLV_OVERHEAD 2U
 
 static const struct tok jnx_ext_tlv_values[] = {
     { JUNIPER_EXT_TLV_IFD_IDX, "Device Interface Index" },
@@ -1200,9 +1200,11 @@ juniper_parse_header(netdissect_options *ndo,
             tlv_len = *(tptr++);
             tlv_value = 0;
 
-            /* sanity check */
+            /* sanity checks */
             if (tlv_type == 0 || tlv_len == 0)
                 break;
+            if (tlv_len+JUNIPER_EXT_TLV_OVERHEAD > jnx_ext_len)
+                goto trunc;
 
             if (ndo->ndo_vflag > 1)
                 ND_PRINT((ndo, "\n\t  %s Extension TLV #%u, length %u, value ",
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 7e37acc..eda358a 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -318,3 +318,4 @@ stp-heapoverflow-3	stp-heapoverflow-3.pcap	stp-heapoverflow-3.out	-t -v -n
 stp-heapoverflow-4	stp-heapoverflow-4.pcap	stp-heapoverflow-4.out	-t -v -n
 stp-heapoverflow-5	stp-heapoverflow-5.pcap	stp-heapoverflow-5.out	-t -v -n
 arp-too-long-tha	arp-too-long-tha.pcap	arp-too-long-tha.out	-t -v -n
+juniper_header-heapoverflow	juniper_header-heapoverflow.pcap	juniper_header-heapoverflow.out	-t -v -n
diff --git a/tests/juniper_header-heapoverflow.out b/tests/juniper_header-heapoverflow.out
new file mode 100644
index 0000000..b13cfbe
--- /dev/null
+++ b/tests/juniper_header-heapoverflow.out
@@ -0,0 +1 @@
+[|juniper_hdr], length 808464432
diff --git a/tests/juniper_header-heapoverflow.pcap b/tests/juniper_header-heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..89cc3310e5a344a06b5ec77bc3f0cd18ee6edd79
GIT binary patch
literal 200
zcmd<$<>fMAU|{gI(UxLlFdzyr0@W)3@g}%>m`(<;2pdqY1c*TZW?&GM?d$H`3KxV)
HQh^2l=B^-q

literal 0
HcmV?d00001

-- 
1.7.9.5

