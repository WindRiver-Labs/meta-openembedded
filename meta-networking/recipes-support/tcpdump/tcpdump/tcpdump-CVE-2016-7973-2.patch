From b56aab38621915a192be3fab9334207a12b1cb9a Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 17:45:06 -0700
Subject: [PATCH] CVE-2016-7973/Add bounds and length checks.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes heap overflows found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-atalk.c                  |    9 +++++++++
 tests/TESTLIST                 |    2 ++
 tests/aarp-heapoverflow-1.out  |    1 +
 tests/aarp-heapoverflow-1.pcap |  Bin 0 -> 329 bytes
 tests/aarp-heapoverflow-2.out  |    1 +
 tests/aarp-heapoverflow-2.pcap |  Bin 0 -> 329 bytes
 6 files changed, 13 insertions(+)
 create mode 100644 tests/aarp-heapoverflow-1.out
 create mode 100644 tests/aarp-heapoverflow-1.pcap
 create mode 100644 tests/aarp-heapoverflow-2.out
 create mode 100644 tests/aarp-heapoverflow-2.pcap

diff --git a/print-atalk.c b/print-atalk.c
index 8460a4f..a5ce58a 100644
--- a/print-atalk.c
+++ b/print-atalk.c
@@ -217,6 +217,15 @@ aarp_print(netdissect_options *ndo,
 
 	ND_PRINT((ndo, "aarp "));
 	ap = (const struct aarp *)bp;
+	if (!ND_TTEST(*ap)) {
+		/* Just bail if we don't have the whole chunk. */
+		ND_PRINT((ndo, " [|aarp]"));
+		return;
+	}
+	if (length < sizeof(*ap)) {	
+		ND_PRINT((ndo, " [|aarp %u]", length));
+		return;
+	}
 	if (EXTRACT_16BITS(&ap->htype) == 1 &&
 	    EXTRACT_16BITS(&ap->ptype) == ETHERTYPE_ATALK &&
 	    ap->halen == 6 && ap->palen == 4 )
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 0442e23..e601f59 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -308,3 +308,5 @@ tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out
 ipcomp-heapoverflow	ipcomp-heapoverflow.pcap	ipcomp-heapoverflow.out	-t -v -n
 llc-xid-heapoverflow	llc-xid-heapoverflow.pcap	llc-xid-heapoverflow.out	-t -v -n
 udp-length-heapoverflow	udp-length-heapoverflow.pcap	udp-length-heapoverflow.out	-t -v -n
+aarp-heapoverflow-1	aarp-heapoverflow-1.pcap	aarp-heapoverflow-1.out	-t -v -n
+aarp-heapoverflow-2	aarp-heapoverflow-2.pcap	aarp-heapoverflow-2.out	-t -v -n
diff --git a/tests/aarp-heapoverflow-1.out b/tests/aarp-heapoverflow-1.out
new file mode 100644
index 0000000..a562223
--- /dev/null
+++ b/tests/aarp-heapoverflow-1.out
@@ -0,0 +1 @@
+aarp  [|aarp]
diff --git a/tests/aarp-heapoverflow-1.pcap b/tests/aarp-heapoverflow-1.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..2524efacbb4b37152900532f17d30488473df1ee
GIT binary patch
literal 329
kcmca|c+)}yB*4eOz`)4B02fh2=0HUoKEtI)8L$ul0C_+^4*&oF

literal 0
HcmV?d00001

diff --git a/tests/aarp-heapoverflow-2.out b/tests/aarp-heapoverflow-2.out
new file mode 100644
index 0000000..a562223
--- /dev/null
+++ b/tests/aarp-heapoverflow-2.out
@@ -0,0 +1 @@
+aarp  [|aarp]
diff --git a/tests/aarp-heapoverflow-2.pcap b/tests/aarp-heapoverflow-2.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..d1b2679001fcdaf44bc186ee164ce2715b94061b
GIT binary patch
literal 329
kcmca|c+)}yBp|@Rz`)4B02fh2=0HUoKEtI)8L$ul0DH1O5dZ)H

literal 0
HcmV?d00001

-- 
1.7.9.5

