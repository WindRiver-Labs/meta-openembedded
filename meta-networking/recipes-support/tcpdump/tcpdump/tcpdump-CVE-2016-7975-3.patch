From ec88d36bcd0d6d0c706d9120183fc73e769a0ad5 Mon Sep 17 00:00:00 2001
From: Guy Harris <guy@alum.mit.edu>
Date: Fri, 3 Jul 2015 16:47:12 -0700
Subject: [PATCH] CVE-2016-7975/Make sure we have the data offset field before
 fetching it.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes a heap overflow found with American Fuzzy Lop by Hanno BÃ¶ck.
---
 print-tcp.c                        |    8 ++++----
 tests/TESTLIST                     |    1 +
 tests/tcp_header_heapoverflow.out  |    2 ++
 tests/tcp_header_heapoverflow.pcap |  Bin 0 -> 329 bytes
 4 files changed, 7 insertions(+), 4 deletions(-)
 create mode 100644 tests/tcp_header_heapoverflow.out
 create mode 100644 tests/tcp_header_heapoverflow.pcap

diff --git a/print-tcp.c b/print-tcp.c
index 3a89e8d..f00ff32 100644
--- a/print-tcp.c
+++ b/print-tcp.c
@@ -187,8 +187,6 @@ tcp_print(netdissect_options *ndo,
         sport = EXTRACT_16BITS(&tp->th_sport);
         dport = EXTRACT_16BITS(&tp->th_dport);
 
-        hlen = TH_OFF(tp) * 4;
-
 #ifdef INET6
         if (ip6) {
                 if (ip6->ip6_nxt == IPPROTO_TCP) {
@@ -216,14 +214,16 @@ tcp_print(netdissect_options *ndo,
                 }
         }
 
+        ND_TCHECK(*tp);
+
+        hlen = TH_OFF(tp) * 4;
+
         if (hlen < sizeof(*tp)) {
                 ND_PRINT((ndo, " tcp %d [bad hdr length %u - too short, < %lu]",
                              length - hlen, hlen, (unsigned long)sizeof(*tp)));
                 return;
         }
 
-        ND_TCHECK(*tp);
-
         seq = EXTRACT_32BITS(&tp->th_seq);
         ack = EXTRACT_32BITS(&tp->th_ack);
         win = EXTRACT_16BITS(&tp->th_win);
diff --git a/tests/TESTLIST b/tests/TESTLIST
index 9ec0142..15c5010 100644
--- a/tests/TESTLIST
+++ b/tests/TESTLIST
@@ -304,3 +304,4 @@ radiotap-heapoverflow	radiotap-heapoverflow.pcap	radiotap-heapoverflow.out -t -v
 isoclns-heapoverflow	isoclns-heapoverflow.pcap	isoclns-heapoverflow.out	-t -v -n
 tcp-auth-heapoverflow	tcp-auth-heapoverflow.pcap	tcp-auth-heapoverflow.out	-t -v -n
 atm-oam-heapoverflow	atm-oam-heapoverflow.pcap	atm-oam-heapoverflow.out	-t -v -n
+tcp_header_heapoverflow	tcp_header_heapoverflow.pcap	tcp_header_heapoverflow.out	-t -v -n
diff --git a/tests/tcp_header_heapoverflow.out b/tests/tcp_header_heapoverflow.out
new file mode 100644
index 0000000..0f830ab
--- /dev/null
+++ b/tests/tcp_header_heapoverflow.out
@@ -0,0 +1,2 @@
+IP (tos 0x30, ttl 48, id 12336, offset 0, flags [none], proto TCP (6), length 12336, bad cksum 3030 (->69a8)!)
+    48.48.48.48.12336 > 48.48.48.48.12336: [|tcp]
diff --git a/tests/tcp_header_heapoverflow.pcap b/tests/tcp_header_heapoverflow.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..547199639a80e9a395def88d00e3f76cbaad1f71
GIT binary patch
literal 329
ocmca|c+)}yB%sH@z`)4B02fh2=0HU`7+k?DpfWbN!jaAZ0G_EmPXGV_

literal 0
HcmV?d00001

-- 
1.7.9.5

