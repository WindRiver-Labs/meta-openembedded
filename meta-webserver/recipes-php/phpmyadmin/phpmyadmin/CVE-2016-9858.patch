From 45e33d63a252011b02b55b74432c4a90484eaa5e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Thu, 18 Aug 2016 16:55:48 +0200
Subject: [PATCH] Limit maximal number of rows in QBE
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

User would be lost in them anyway by that count and it prevents DOS.

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 libraries/DbQbe.php         |    5 ++++-
 libraries/SavedSearches.php |   10 ++++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/libraries/DbQbe.php b/libraries/DbQbe.php
index d9d1f3c..08eb4cc 100644
--- a/libraries/DbQbe.php
+++ b/libraries/DbQbe.php
@@ -1940,7 +1940,10 @@ class DbQbe
         // sets row count
         $rows = PMA_ifSetOr($_REQUEST['rows'], 0, 'numeric');
         $criteriaRowAdd = PMA_ifSetOr($_REQUEST['criteriaRowAdd'], 0, 'numeric');
-        $this->_criteria_row_count = max($rows + $criteriaRowAdd, 0);
+        $this->_criteria_row_count = min(
+            100,
+            max($rows + $criteriaRowAdd, 0)
+        );
 
         return $criteriaColumnCount;
     }
diff --git a/libraries/SavedSearches.php b/libraries/SavedSearches.php
index ccbd9c5..6c2c0c2 100644
--- a/libraries/SavedSearches.php
+++ b/libraries/SavedSearches.php
@@ -160,6 +160,16 @@ class SavedSearches
             }
         }
 
+        /* Limit amount of rows */
+        if (!isset($data['rows'])) {
+            $data['rows'] = 0;
+        } else {
+            $data['rows'] = min(
+                max(0, intval($data['rows'])),
+                100
+            );
+        }
+
         for ($i = 0; $i <= $data['rows']; $i++) {
             $data['Or' . $i] = $criterias['Or' . $i];
         }
-- 
1.7.9.5

