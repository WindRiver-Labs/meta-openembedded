From 80b03a4f1629957c4b3f22288147e5ed8495856b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Tue, 12 Jul 2016 16:47:50 +0200
Subject: [PATCH] Ensure page number is integer
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Even if somebody decides to change configuration storage structure.

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 libraries/db_designer.lib.php                     |    2 +-
 libraries/plugins/export/ExportSql.php            |    2 +-
 libraries/plugins/schema/ExportRelationSchema.php |    2 +-
 libraries/pmd_common.php                          |   12 ++++++------
 libraries/relation.lib.php                        |    2 +-
 5 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/libraries/db_designer.lib.php b/libraries/db_designer.lib.php
index 34e2028..bf52111 100644
--- a/libraries/db_designer.lib.php
+++ b/libraries/db_designer.lib.php
@@ -90,7 +90,7 @@ function PMA_getPageIdsAndNames($db)
 
     $result = array();
     while ($curr_page = $GLOBALS['dbi']->fetchAssoc($page_rs)) {
-        $result[$curr_page['page_nr']] = $curr_page['page_descr'];
+        $result[intval($curr_page['page_nr'])] = $curr_page['page_descr'];
     }
     return $result;
 }
diff --git a/libraries/plugins/export/ExportSql.php b/libraries/plugins/export/ExportSql.php
index 7812c7c..20a8cfa 100644
--- a/libraries/plugins/export/ExportSql.php
+++ b/libraries/plugins/export/ExportSql.php
@@ -1112,7 +1112,7 @@ class ExportSql extends ExportPlugin
                                 $dbNameColumn
                             )
                             . " = '" . Util::sqlAddSlashes($db) . "'"
-                            . " AND `page_nr` = '" . $page . "'";
+                            . " AND `page_nr` = '" . intval($page) . "'";
 
                         if (!$this->exportData(
                             $cfgRelation['db'],
diff --git a/libraries/plugins/schema/ExportRelationSchema.php b/libraries/plugins/schema/ExportRelationSchema.php
index 4ca5503..228af6c 100644
--- a/libraries/plugins/schema/ExportRelationSchema.php
+++ b/libraries/plugins/schema/ExportRelationSchema.php
@@ -53,7 +53,7 @@ class ExportRelationSchema
      */
     public function setPageNumber($value)
     {
-        $this->pageNumber = $value;
+        $this->pageNumber = intval($value);
     }
 
     /**
diff --git a/libraries/pmd_common.php b/libraries/pmd_common.php
index 5b84015..03e018c 100644
--- a/libraries/pmd_common.php
+++ b/libraries/pmd_common.php
@@ -261,7 +261,7 @@ function PMA_getTablePositions($pg)
             1 AS `H`
         FROM " . PMA\libraries\Util::backquote($cfgRelation['db'])
             . "." . PMA\libraries\Util::backquote($cfgRelation['table_coords']) . "
-        WHERE pdf_page_number = " . $pg;
+        WHERE pdf_page_number = " . intval($pg);
 
     $tab_pos = $GLOBALS['dbi']->fetchResult(
         $query,
@@ -290,7 +290,7 @@ function PMA_getPageName($pg)
     $query = "SELECT `page_descr`"
         . " FROM " . PMA\libraries\Util::backquote($cfgRelation['db'])
         . "." . PMA\libraries\Util::backquote($cfgRelation['pdf_pages'])
-        . " WHERE " . PMA\libraries\Util::backquote('page_nr') . " = " . $pg;
+        . " WHERE " . PMA\libraries\Util::backquote('page_nr') . " = " . intval($pg);
     $page_name = $GLOBALS['dbi']->fetchResult(
         $query,
         null,
@@ -317,7 +317,7 @@ function PMA_deletePage($pg)
 
     $query = "DELETE FROM " . PMA\libraries\Util::backquote($cfgRelation['db'])
         . "." . PMA\libraries\Util::backquote($cfgRelation['table_coords'])
-        . " WHERE " . PMA\libraries\Util::backquote('pdf_page_number') . " = " . $pg;
+        . " WHERE " . PMA\libraries\Util::backquote('pdf_page_number') . " = " . intval($pg);
     $success = PMA_queryAsControlUser(
         $query, true, PMA\libraries\DatabaseInterface::QUERY_STORE
     );
@@ -325,7 +325,7 @@ function PMA_deletePage($pg)
     if ($success) {
         $query = "DELETE FROM " . PMA\libraries\Util::backquote($cfgRelation['db'])
             . "." . PMA\libraries\Util::backquote($cfgRelation['pdf_pages'])
-            . " WHERE " . PMA\libraries\Util::backquote('page_nr') . " = " . $pg;
+            . " WHERE " . PMA\libraries\Util::backquote('page_nr') . " = " . intval($pg);
         $success = PMA_queryAsControlUser(
             $query, true, PMA\libraries\DatabaseInterface::QUERY_STORE
         );
@@ -364,7 +364,7 @@ function PMA_getDefaultPage($db)
     );
 
     if (count($default_page_no)) {
-        return $default_page_no[0];
+        return intval($default_page_no[0]);
     }
     return -1;
 }
@@ -406,7 +406,7 @@ function PMA_getLoadingPage($db)
             $page_no = $min_page_no[0];
         }
     }
-    return $page_no;
+    return intval($page_no);
 }
 
 /**
diff --git a/libraries/relation.lib.php b/libraries/relation.lib.php
index 19c21cb..e99cd9a 100644
--- a/libraries/relation.lib.php
+++ b/libraries/relation.lib.php
@@ -1665,7 +1665,7 @@ function PMA_REL_renameTable($source_db, $target_db, $source_table, $target_tabl
  * @param array  $cfgRelation Relation configuration
  * @param string $db          database name
  *
- * @return string   $pdf_page_number
+ * @return int $pdf_page_number
  */
 function PMA_REL_createPage($newpage, $cfgRelation, $db)
 {
-- 
1.7.9.5

