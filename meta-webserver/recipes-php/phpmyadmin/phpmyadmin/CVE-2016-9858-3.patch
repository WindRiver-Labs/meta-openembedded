From 8119464150081bcc18641281d62991bdff5feff7 Mon Sep 17 00:00:00 2001
From: Deven Bansod <devenbansod.bits@gmail.com>
Date: Tue, 8 Nov 2016 10:11:01 +0530
Subject: [PATCH] Handle multiple `:p` while sanitizing MySQL hosts

Signed-off-by: Deven Bansod <devenbansod.bits@gmail.com>
---
 libraries/core.lib.php                             |    6 +++---
 test/libraries/core/PMA_sanitizeMySQLHost_test.php |    1 +
 2 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/libraries/core.lib.php b/libraries/core.lib.php
index ef79c91..cb7161d 100644
--- a/libraries/core.lib.php
+++ b/libraries/core.lib.php
@@ -1022,7 +1022,7 @@ if (! function_exists('hash_hmac')) {
 /**
  * Sanitizes MySQL hostname
  *
- * * strips p: prefix
+ * * strips p: prefix(es)
  *
  * @param string $name User given hostname
  *
@@ -1030,8 +1030,8 @@ if (! function_exists('hash_hmac')) {
  */
 function PMA_sanitizeMySQLHost($name)
 {
-    if (strtolower(substr($name, 0, 2)) == 'p:') {
-        return substr($name, 2);
+    while (strtolower(substr($name, 0, 2)) == 'p:') {
+        $name = substr($name, 2);
     }
 
     return $name;
diff --git a/test/libraries/core/PMA_sanitizeMySQLHost_test.php b/test/libraries/core/PMA_sanitizeMySQLHost_test.php
index 1b44047..d17ca53 100644
--- a/test/libraries/core/PMA_sanitizeMySQLHost_test.php
+++ b/test/libraries/core/PMA_sanitizeMySQLHost_test.php
@@ -40,6 +40,7 @@ class PMA_sanitizeMySQLHost_test extends PHPUnit_Framework_TestCase
     {
         return array(
             array('p:foo.bar', 'foo.bar'),
+            array('p:p:foo.bar', 'foo.bar'),
             array('bar.baz', 'bar.baz'),
             array('P:example.com', 'example.com'),
         );
-- 
1.7.9.5

