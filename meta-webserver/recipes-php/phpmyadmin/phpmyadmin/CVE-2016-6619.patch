From 7ef96c5cdc2adc16f4d8530ad90c76715825d471 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Tue, 12 Jul 2016 17:35:56 +0200
Subject: [PATCH] Correctly escape MySQL username in queries
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 libraries/RecentFavoriteTable.php |    4 ++--
 libraries/Table.php               |    4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/libraries/RecentFavoriteTable.php b/libraries/RecentFavoriteTable.php
index 6d76660..6063b75 100644
--- a/libraries/RecentFavoriteTable.php
+++ b/libraries/RecentFavoriteTable.php
@@ -96,7 +96,7 @@ class RecentFavoriteTable
         // Read from phpMyAdmin database, if recent tables is not in session
         $sql_query
             = " SELECT `tables` FROM " . $this->_getPmaTable() .
-            " WHERE `username` = '" . $GLOBALS['cfg']['Server']['user'] . "'";
+            " WHERE `username` = '" . Util::sqlAddSlashes($GLOBALS['cfg']['Server']['user']) . "'";
 
         $return = array();
         $result = PMA_queryAsControlUser($sql_query, false);
@@ -119,7 +119,7 @@ class RecentFavoriteTable
         $username = $GLOBALS['cfg']['Server']['user'];
         $sql_query
             = " REPLACE INTO " . $this->_getPmaTable() . " (`username`, `tables`)" .
-                " VALUES ('" . $username . "', '"
+                " VALUES ('" . Util::sqlAddSlashes($username) . "', '"
                 . Util::sqlAddSlashes(
                     json_encode($this->_tables)
                 ) . "')";
diff --git a/libraries/Table.php b/libraries/Table.php
index 7e4a9ad..cddb1d9 100644
--- a/libraries/Table.php
+++ b/libraries/Table.php
@@ -1494,7 +1494,7 @@ class Table
 
         // Read from phpMyAdmin database
         $sql_query = " SELECT `prefs` FROM " . $pma_table
-            . " WHERE `username` = '" . $GLOBALS['cfg']['Server']['user'] . "'"
+            . " WHERE `username` = '" . Util::sqlAddSlashes($GLOBALS['cfg']['Server']['user']) . "'"
             . " AND `db_name` = '" . Util::sqlAddSlashes($this->_db_name) . "'"
             . " AND `table_name` = '" . Util::sqlAddSlashes($this->_name) . "'";
 
@@ -1522,7 +1522,7 @@ class Table
         $username = $GLOBALS['cfg']['Server']['user'];
         $sql_query = " REPLACE INTO " . $pma_table
             . " (username, db_name, table_name, prefs) VALUES ('"
-            . $username . "', '" . $secureDbName
+            . Util::sqlAddSlashes($username) . "', '" . $secureDbName
             . "', '" . Util::sqlAddSlashes($this->_name) . "', '"
             . Util::sqlAddSlashes(json_encode($this->uiprefs)) . "')";
 
-- 
1.7.9.5

