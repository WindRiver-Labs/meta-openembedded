From 9dbe520e905344597554b06931bd966ce195b9dc Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Thu, 18 Aug 2016 09:08:06 +0200
Subject: [PATCH] Strip null bytes from MySQL username
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In old PHP versions this could lead to allow/deny rules bypass.

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 libraries/core.lib.php                          |   18 ++++++++++++++++++
 libraries/plugins/auth/AuthenticationCookie.php |    2 +-
 libraries/plugins/auth/AuthenticationHttp.php   |    3 +++
 3 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/libraries/core.lib.php b/libraries/core.lib.php
index 87aefa2..e7cef9e 100644
--- a/libraries/core.lib.php
+++ b/libraries/core.lib.php
@@ -1030,6 +1030,24 @@ function PMA_sanitizeMySQLHost($name)
 }
 
 /**
+ * Sanitizes MySQL username
+ *
+ * * strips part behind null byte
+ *
+ * @param string $name User given username
+ *
+ * @return string
+ */
+function PMA_sanitizeMySQLUser($name)
+{
+    $position = strpos($name, chr(0));
+    if ($position !== false) {
+        return substr($name, 0, $position);
+    }
+    return $name;
+}
+
+/**
  * Safe unserializer wrapper
  *
  * It does not unserialize data containing objects
diff --git a/libraries/plugins/auth/AuthenticationCookie.php b/libraries/plugins/auth/AuthenticationCookie.php
index 12e6c91..ab2baa0 100644
--- a/libraries/plugins/auth/AuthenticationCookie.php
+++ b/libraries/plugins/auth/AuthenticationCookie.php
@@ -301,7 +301,7 @@ class AuthenticationCookie extends AuthenticationPlugin
             }
 
             // The user just logged in
-            $GLOBALS['PHP_AUTH_USER'] = $_REQUEST['pma_username'];
+            $GLOBALS['PHP_AUTH_USER'] = PMA_sanitizeMySQLUser($_REQUEST['pma_username']);
             $GLOBALS['PHP_AUTH_PW']   = empty($_REQUEST['pma_password'])
                 ? ''
                 : $_REQUEST['pma_password'];
diff --git a/libraries/plugins/auth/AuthenticationHttp.php b/libraries/plugins/auth/AuthenticationHttp.php
index 62dcc01..0bad9ed 100644
--- a/libraries/plugins/auth/AuthenticationHttp.php
+++ b/libraries/plugins/auth/AuthenticationHttp.php
@@ -167,6 +167,9 @@ class AuthenticationHttp extends AuthenticationPlugin
             unset($usr_pass);
         }
 
+        // sanitize username
+        $PHP_AUTH_USER = PMA_sanitizeMySQLUser($PHP_AUTH_USER);
+
         // User logged out -> ensure the new username is not the same
         $old_usr = isset($_REQUEST['old_usr']) ? $_REQUEST['old_usr'] : '';
         if (!empty($old_usr)
-- 
1.7.9.5

