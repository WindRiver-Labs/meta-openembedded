From 67d6eeac42c599e53e81781961dadfcb3d8aac23 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Mon, 18 Jul 2016 16:39:25 +0200
Subject: [PATCH] Improve URL filtering in url.php
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 libraries/core.lib.php                           |    4 ++++
 test/libraries/core/PMA_isAllowedDomain_test.php |    3 ++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/libraries/core.lib.php b/libraries/core.lib.php
index 7aa04f9..b2804f5 100644
--- a/libraries/core.lib.php
+++ b/libraries/core.lib.php
@@ -764,6 +764,10 @@ function PMA_linkURL($url)
 function PMA_isAllowedDomain($url)
 {
     $arr = parse_url($url);
+    // Avoid URLs without hostname or with credentials
+    if (empty($arr['host']) || ! empty($arr['user']) || ! empty($arr['pass'])) {
+        return false;
+    }
     $domain = $arr["host"];
     $domainWhiteList = array(
         /* Include current domain */
diff --git a/test/libraries/core/PMA_isAllowedDomain_test.php b/test/libraries/core/PMA_isAllowedDomain_test.php
index ad5296f..586e6bc 100644
--- a/test/libraries/core/PMA_isAllowedDomain_test.php
+++ b/test/libraries/core/PMA_isAllowedDomain_test.php
@@ -41,9 +41,10 @@ class PMA_isAllowedDomain_test extends PHPUnit_Framework_TestCase
     {
         return array(
             array('https://www.phpmyadmin.net/', true),
-            array('http://duckduckgo.com\\@github.com', true),
+            array('http://duckduckgo.com\\@github.com', false),
             array('https://github.com/', true),
             array('https://server.local/', true),
+            array('./relative/', false),
         );
     }
 
-- 
1.7.9.5

