From 0bf21ebf720a552c8e727a6cca1c653e20c3160a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Tue, 12 Jul 2016 10:36:33 +0200
Subject: [PATCH] Use whitelist rather than blacklist for URL filtering
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 .../abs/TextImageLinkTransformationsPlugin.php     |    2 +-
 .../abs/TextLinkTransformationsPlugin.php          |    2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/libraries/plugins/transformations/abs/TextImageLinkTransformationsPlugin.php b/libraries/plugins/transformations/abs/TextImageLinkTransformationsPlugin.php
index d341f59..800a76e 100644
--- a/libraries/plugins/transformations/abs/TextImageLinkTransformationsPlugin.php
+++ b/libraries/plugins/transformations/abs/TextImageLinkTransformationsPlugin.php
@@ -49,7 +49,7 @@ abstract class TextImageLinkTransformationsPlugin extends TransformationsPlugin
         $url = (isset($options[0]) ? $options[0] : '') . $buffer;
         $parsed = parse_url($url);
         /* Do not allow javascript links */
-        if (isset($parsed['scheme']) && $parsed['scheme'] == 'javascript') {
+        if (! isset($parsed['scheme']) || ! in_array(strtolower($parsed['scheme']), array('http', 'https', 'ftp', 'mailto'))) {
             return htmlspecialchars($url);
         }
         return '<a href="' . htmlspecialchars($url)
diff --git a/libraries/plugins/transformations/abs/TextLinkTransformationsPlugin.php b/libraries/plugins/transformations/abs/TextLinkTransformationsPlugin.php
index a125b01..14e3fda 100644
--- a/libraries/plugins/transformations/abs/TextLinkTransformationsPlugin.php
+++ b/libraries/plugins/transformations/abs/TextLinkTransformationsPlugin.php
@@ -49,7 +49,7 @@ abstract class TextLinkTransformationsPlugin extends TransformationsPlugin
         $url = (isset($options[0]) ? $options[0] : '') . ((isset($options[2]) && $options[2]) ? '' : $buffer);
         $parsed = parse_url($url);
         /* Do not allow javascript links */
-        if (isset($parsed['scheme']) && $parsed['scheme'] == 'javascript') {
+        if (! isset($parsed['scheme']) || ! in_array(strtolower($parsed['scheme']), array('http', 'https', 'ftp', 'mailto'))) {
             return htmlspecialchars($url);
         }
         return '<a href="'
-- 
1.7.9.5

