From c962ee4287b50af754b8fe72c0c4ef6cebf3c489 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Wed, 21 Dec 2016 11:26:52 +0100
Subject: [PATCH] Remove setup download/load/delete features
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This removes risk of third party manipulating with the configuration as
there was race condition between editing and using the file.

Downloading the file should not be big hassle and this really makes the
whole setup a bit simpler.

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 doc/setup.rst                          |   59 +++-------------------------
 libraries/config/ConfigFile.php        |   10 -----
 libraries/vendor_config.php            |   11 ------
 setup/config.php                       |   53 -------------------------
 setup/frames/config.inc.php            |    9 -----
 setup/frames/index.inc.php             |   40 -------------------
 setup/lib/index.lib.php                |   25 ------------
 test/classes/config/ConfigFileTest.php |   11 ------
 test/libraries/PMA_SetupIndex_test.php |   67 --------------------------------
 9 files changed, 6 insertions(+), 279 deletions(-)

diff --git a/doc/setup.rst b/doc/setup.rst
index 5f8e146..b6be504 100644
--- a/doc/setup.rst
+++ b/doc/setup.rst
@@ -305,60 +305,13 @@ Using Setup script
 ------------------
 
 Instead of manually editing :file:`config.inc.php`, you can use phpMyAdmin's 
-setup feature. First you must manually create a folder ``config``
-in the phpMyAdmin directory. This is a security measure. On a
-Linux/Unix system you can use the following commands:
+setup feature. The file can be generated using the setup and you can download it 
+for upload to the server.
 
-.. code-block:: sh
-
-
-    cd phpMyAdmin
-    mkdir config                        # create directory for saving
-    chmod o+rw config                   # give it world writable permissions
-
-And to edit an existing configuration, copy it over first:
-
-.. code-block:: sh
-
-
-    cp config.inc.php config/           # copy current configuration for editing
-    chmod o+w config/config.inc.php     # give it world writable permissions
-
-.. note::
-
-    Debian and Ubuntu have simplified this setup and all you need to do is to
-    execute :program:`/usr/sbin/pma-configure`.
-
-On other platforms, simply create the folder and ensure that your web
-server has read and write access to it. :ref:`faq1_26` can help with
-this.
-
-Next, open your browser and visit the location where you installed phpMyAdmin, with the ``/setup`` suffix. If you have an existing configuration,
-use the ``Load`` button to bring its content inside the setup panel.
-Note that **changes are not saved to disk until you explicitly choose ``Save``**
-from the *Configuration* area of the screen. Normally the script saves the new
-:file:`config.inc.php` to the ``config/`` directory, but if the webserver does
-not have the proper permissions you may see the error "Cannot load or
-save configuration." Ensure that the ``config/`` directory exists and
-has the proper permissions - or use the ``Download`` link to save the
-config file locally and upload it (via FTP or some similar means) to the
-proper location.
-
-Once the file has been saved, it must be moved out of the ``config/``
-directory and the permissions must be reset, again as a security
-measure:
-
-.. code-block:: sh
-
-
-    mv config/config.inc.php .         # move file to current directory
-    chmod o-rw config.inc.php          # remove world read and write permissions
-    rm -rf config                      # remove not needed directory
-
-.. note::
-
-    Debian and Ubuntu have simplified this setup and all you need to do is to
-    execute :program:`/usr/sbin/pma-secure`.
+Next, open your browser and visit the location where you installed phpMyAdmin,
+with the ``/setup`` suffix. The changes are not saved to the server, you need to 
+use the :guilabel:`Download` button to save them to your computer and then upload 
+to the server.
 
 Now the file is ready to be used. You can choose to review or edit the
 file with your favorite editor, if you prefer to set some advanced
diff --git a/libraries/config/ConfigFile.php b/libraries/config/ConfigFile.php
index b74c1cc..a28888e 100644
--- a/libraries/config/ConfigFile.php
+++ b/libraries/config/ConfigFile.php
@@ -483,16 +483,6 @@ class ConfigFile
     }
 
     /**
-     * Returns config file path, relative to phpMyAdmin's root path
-     *
-     * @return string
-     */
-    public function getFilePath()
-    {
-        return SETUP_CONFIG_FILE;
-    }
-
-    /**
      * Returns configuration array (full, multidimensional format)
      *
      * @return array
diff --git a/libraries/vendor_config.php b/libraries/vendor_config.php
index 025eba3..56e71ab 100644
--- a/libraries/vendor_config.php
+++ b/libraries/vendor_config.php
@@ -26,17 +26,6 @@ define('CHANGELOG_FILE', './ChangeLog');
 define('LICENSE_FILE', './LICENSE');
 
 /**
- * Path to config file generated using setup script.
- */
-define('SETUP_CONFIG_FILE', './config/config.inc.php');
-
-/**
- * Whether setup requires writable directory where config
- * file will be generated.
- */
-define('SETUP_DIR_WRITABLE', true);
-
-/**
  * Directory where SQL scripts to create/upgrade configuration storage reside.
  */
 define('SQL_DIR', './sql/');
diff --git a/setup/config.php b/setup/config.php
index db9e7c9..372cd9f 100644
--- a/setup/config.php
+++ b/setup/config.php
@@ -15,28 +15,9 @@ require './lib/common.inc.php';
 
 require './libraries/config/setup.forms.php';
 
-/**
- * Loads configuration file path
- *
- * Do this in a function to avoid messing up with global $cfg
- *
- * @param string $config_file_path
- *
- * @return array
- */
-function loadConfig($config_file_path)
-{
-    $cfg = array();
-    if (file_exists($config_file_path)) {
-        include $config_file_path;
-    }
-    return $cfg;
-}
-
 $form_display = new FormDisplay($GLOBALS['ConfigFile']);
 $form_display->registerForm('_config.php', $forms['_config.php']);
 $form_display->save('_config.php');
-$config_file_path = $GLOBALS['ConfigFile']->getFilePath();
 
 if (isset($_POST['eol'])) {
     $_SESSION['eol'] = ($_POST['eol'] == 'unix') ? 'unix' : 'win';
@@ -58,40 +39,6 @@ if (PMA_ifSetOr($_POST['submit_clear'], '')) {
     PMA_downloadHeader('config.inc.php', 'text/plain');
     echo ConfigGenerator::getConfigFile($GLOBALS['ConfigFile']);
     exit;
-} elseif (PMA_ifSetOr($_POST['submit_save'], '')) {
-    //
-    // Save generated config file on the server
-    //
-    $result = @file_put_contents(
-        $config_file_path,
-        ConfigGenerator::getConfigFile($GLOBALS['ConfigFile'])
-    );
-    if ($result === false) {
-        $state = 'config_not_saved';
-    } else {
-        $state = 'config_saved';
-    }
-    header('HTTP/1.1 303 See Other');
-    header('Location: index.php' . PMA_URL_getCommon() . '&action_done=' . $state);
-    exit;
-} elseif (PMA_ifSetOr($_POST['submit_load'], '')) {
-    //
-    // Load config file from the server
-    //
-    $GLOBALS['ConfigFile']->setConfigData(
-        loadConfig($config_file_path)
-    );
-    header('HTTP/1.1 303 See Other');
-    header('Location: index.php' . PMA_URL_getCommon());
-    exit;
-} elseif (PMA_ifSetOr($_POST['submit_delete'], '')) {
-    //
-    // Delete config file on the server
-    //
-    @unlink($config_file_path);
-    header('HTTP/1.1 303 See Other');
-    header('Location: index.php' . PMA_URL_getCommon());
-    exit;
 } else {
     //
     // Show generated config file in a <textarea>
diff --git a/setup/frames/config.inc.php b/setup/frames/config.inc.php
index c04359a..783961f 100644
--- a/setup/frames/config.inc.php
+++ b/setup/frames/config.inc.php
@@ -18,10 +18,6 @@ if (!defined('PHPMYADMIN')) {
 require_once './libraries/config/FormDisplay.tpl.php';
 require_once './setup/lib/index.lib.php';
 
-$config_readable = false;
-$config_writable = false;
-$config_exists = false;
-PMA_checkConfigRw($config_readable, $config_writable, $config_exists);
 echo '<h2>' , __('Configuration file') , '</h2>';
 
 echo PMA_displayFormTop('config.php');
@@ -40,11 +36,6 @@ echo '<tr>';
 echo '<td class="lastrow" style="text-align: left">';
 echo '<input type="submit" name="submit_download" value="'
     , __('Download') , '" class="green" />';
-echo '<input type="submit" name="submit_save" value="' , __('Save') , '"';
-if (!$config_writable) {
-    echo ' disabled="disabled"';
-}
-echo '/>';
 echo '</td>';
 echo '</tr>';
 
diff --git a/setup/frames/index.inc.php b/setup/frames/index.inc.php
index eee9a42..3b3f3dd 100644
--- a/setup/frames/index.inc.php
+++ b/setup/frames/index.inc.php
@@ -46,26 +46,6 @@ $configChecker = new ServerConfigChecks($GLOBALS['ConfigFile']);
 $configChecker->performConfigChecks();
 
 //
-// Check whether we can read/write configuration
-//
-$config_readable = false;
-$config_writable = false;
-$config_exists = false;
-PMA_checkConfigRw($config_readable, $config_writable, $config_exists);
-if (!$config_writable || !$config_readable) {
-    PMA_messagesSet(
-        'error', 'config_rw', __('Cannot load or save configuration'),
-        PMA_sanitize(
-            __(
-                'Please create web server writable folder [em]config[/em] in '
-                . 'phpMyAdmin top level directory as described in '
-                . '[doc@setup_script]documentation[/doc]. Otherwise you will be '
-                . 'only able to download or display it.'
-            )
-        )
-    );
-}
-//
 // Check https connection
 //
 $is_https = !empty($_SERVER['HTTPS'])
@@ -288,26 +268,6 @@ echo '<td colspan="2" class="lastrow" style="text-align: left">';
 echo '<input type="submit" name="submit_display" value="' , __('Display') , '" />';
 echo '<input type="submit" name="submit_download" value="' , __('Download') , '" />';
 echo '&nbsp; &nbsp;';
-
-echo '<input type="submit" name="submit_save" value="' , __('Save') , '"';
-if (!$config_writable) {
-    echo ' disabled="disabled"';
-}
-echo '/>';
-
-echo '<input type="submit" name="submit_load" value="' , __('Load') , '"';
-if (!$config_exists) {
-    echo ' disabled="disabled"';
-}
-echo '/>';
-
-echo '<input type="submit" name="submit_delete" value="' , __('Delete') , '"';
-if (!$config_exists || !$config_writable) {
-    echo ' disabled="disabled"';
-}
-echo '/>';
-
-echo '&nbsp; &nbsp;';
 echo '<input type="submit" name="submit_clear" value="' , __('Clear')
     , '" class="red" />';
 echo '</td>';
diff --git a/setup/lib/index.lib.php b/setup/lib/index.lib.php
index 17451b5..2b873fe 100644
--- a/setup/lib/index.lib.php
+++ b/setup/lib/index.lib.php
@@ -181,28 +181,3 @@ function PMA_versionCheck()
         }
     }
 }
-
-/**
- * Checks whether config file is readable/writable
- *
- * @param bool &$is_readable whether the file is readable
- * @param bool &$is_writable whether the file is writable
- * @param bool &$file_exists whether the file exists
- *
- * @return void
- */
-function PMA_checkConfigRw(&$is_readable, &$is_writable, &$file_exists)
-{
-    $file_path = $GLOBALS['ConfigFile']->getFilePath();
-    $file_dir = dirname($file_path);
-    $is_readable = true;
-    $is_writable = @is_dir($file_dir);
-    if (SETUP_DIR_WRITABLE) {
-        $is_writable = $is_writable && @is_writable($file_dir);
-    }
-    $file_exists = file_exists($file_path);
-    if ($file_exists) {
-        $is_readable = is_readable($file_path);
-        $is_writable = $is_writable && @is_writable($file_path);
-    }
-}
diff --git a/test/classes/config/ConfigFileTest.php b/test/classes/config/ConfigFileTest.php
index df77943..de8c5b2 100644
--- a/test/classes/config/ConfigFileTest.php
+++ b/test/classes/config/ConfigFileTest.php
@@ -578,17 +578,6 @@ class ConfigFileTest extends PMATestCase
     }
 
     /**
-     * Test for ConfigFile::getFilePath
-     *
-     * @return void
-     * @test
-     */
-    public function testGetFilePath()
-    {
-        $this->assertNotEmpty($this->object->getFilePath());
-    }
-
-    /**
      * Test for ConfigFile::getConfigArray
      *
      * @return void
diff --git a/test/libraries/PMA_SetupIndex_test.php b/test/libraries/PMA_SetupIndex_test.php
index 0acaa7f..451c941 100644
--- a/test/libraries/PMA_SetupIndex_test.php
+++ b/test/libraries/PMA_SetupIndex_test.php
@@ -160,73 +160,6 @@ class PMA_SetupIndex_Test extends PHPUnit_Framework_TestCase
     }
 
     /**
-     * Test for PMA_checkConfigRw
-     *
-     * @return void
-     */
-    public function testPMACheckConfigRw()
-    {
-        if (! PMA_HAS_RUNKIT) {
-            $this->markTestSkipped('Cannot redefine constant');
-        }
-
-        $redefine = null;
-        $GLOBALS['cfg']['AvailableCharsets'] = array();
-        $GLOBALS['server'] = 0;
-        $GLOBALS['ConfigFile'] = new ConfigFile();
-        if (!defined('SETUP_CONFIG_FILE')) {
-            define('SETUP_CONFIG_FILE', 'test/test_data/configfile');
-        } else {
-            $redefine = 'SETUP_CONFIG_FILE';
-            runkit_constant_redefine(
-                'SETUP_CONFIG_FILE',
-                'test/test_data/configfile'
-            );
-        }
-        $is_readable = false;
-        $is_writable = false;
-        $file_exists = false;
-
-        PMA_checkConfigRw($is_readable, $is_writable, $file_exists);
-
-        $this->assertTrue(
-            $is_readable
-        );
-
-        $this->assertTrue(
-            $is_writable
-        );
-
-        $this->assertFalse(
-            $file_exists
-        );
-
-        runkit_constant_redefine(
-            'SETUP_CONFIG_FILE',
-            'test/test_data/test.file'
-        );
-
-        PMA_checkConfigRw($is_readable, $is_writable, $file_exists);
-
-        $this->assertTrue(
-            $is_readable
-        );
-
-        $this->assertTrue(
-            $is_writable
-        );
-
-        $this->assertTrue(
-            $file_exists
-        );
-
-        if ($redefine !== null) {
-            runkit_constant_redefine('SETUP_CONFIG_FILE', $redefine);
-        } else {
-            runkit_constant_remove('SETUP_CONFIG_FILE');
-        }
-    }
-
     /**
      * Test for ServerConfigChecks::performConfigChecks
      *
-- 
1.7.9.5

