From 0d57c09bd582f6f138bb4583374a83b673520fa7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Tue, 12 Jul 2016 12:47:35 +0200
Subject: [PATCH] Do not allow symlinks in UploadDir
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 import.php                     |    9 +++++++++
 libraries/File.php             |    5 +++++
 libraries/file_listing.lib.php |    1 +
 3 files changed, 15 insertions(+)

diff --git a/import.php b/import.php
index ae0eaef..a43eff6 100644
--- a/import.php
+++ b/import.php
@@ -435,6 +435,15 @@ if (! empty($local_import_file) && ! empty($cfg['UploadDir'])) {
     $import_file = PMA\libraries\Util::userDir($cfg['UploadDir'])
         . $local_import_file;
 
+    /*
+     * Do not allow symlinks to avoid security issues
+     * (user can create symlink to file he can not access,
+     * but phpMyAdmin can).
+     */
+    if (@is_link($import_file)) {
+        $import_file  = 'none';
+    }
+
 } elseif (empty($import_file) || ! is_uploaded_file($import_file)) {
     $import_file  = 'none';
 }
diff --git a/libraries/File.php b/libraries/File.php
index b456fb2..4d71dc3 100644
--- a/libraries/File.php
+++ b/libraries/File.php
@@ -420,6 +420,11 @@ class File
         $this->setName(
             Util::userDir($GLOBALS['cfg']['UploadDir']) . PMA_securePath($name)
         );
+        if (@is_link($this->getName())) {
+            $this->_error_message = __('File is a symbolic link');
+            $this->setName(null);
+            return false;
+        }
         if (! $this->isReadable()) {
             $this->_error_message = __('File could not be read!');
             $this->setName(null);
diff --git a/libraries/file_listing.lib.php b/libraries/file_listing.lib.php
index 64f7230..64b469b 100644
--- a/libraries/file_listing.lib.php
+++ b/libraries/file_listing.lib.php
@@ -26,6 +26,7 @@ function PMA_getDirContent($dir, $expression = '')
     }
     while ($file = @readdir($handle)) {
         if (@is_file($dir . $file)
+            && ! @is_link($dir . $file)
             && ($expression == '' || preg_match($expression, $file))
         ) {
             $result[] = $file;
-- 
1.7.9.5

