From 6e3282e15856192d484f2c56a7ae83796bf2e716 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michal=20=C4=8Ciha=C5=99?= <michal@cihar.com>
Date: Thu, 18 Aug 2016 11:05:56 +0200
Subject: [PATCH] Store copy of hash instead of working on live object
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This avoids possible race conditions when doing the checks.

Signed-off-by: Michal Čihař <michal@cihar.com>
---
 js/microhistory.js |   13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/js/microhistory.js b/js/microhistory.js
index 60bb207..4263cd0 100644
--- a/js/microhistory.js
+++ b/js/microhistory.js
@@ -280,15 +280,16 @@ PMA_SetUrlHash = (function (jQuery, window) {
     /**
      * Start initialisation
      */
-    if (window.location.hash.substring(0, 8) == '#PMAURL-') {
+    var urlhash = window.location.hash;
+    if (urlhash.substring(0, 8) == '#PMAURL-') {
         // We have a valid hash, let's redirect the user
         // to the page that it's pointing to
-        var colon_position = window.location.hash.indexOf(':');
-        var questionmark_position = window.location.hash.indexOf('?');
+        var colon_position = urlhash.indexOf(':');
+        var questionmark_position = urlhash.indexOf('?');
         if (colon_position != -1 && questionmark_position != -1 && colon_position < questionmark_position) {
-            var hash_url = window.location.hash.substring(colon_position + 1, questionmark_position);
+            var hash_url = urlhash.substring(colon_position + 1, questionmark_position);
             if (PMA_gotoWhitelist.indexOf(hash_url) != -1) {
-                window.location = window.location.hash.substring(
+                window.location = urlhash.substring(
                     colon_position + 1
                 );
             }
@@ -328,4 +329,4 @@ PMA_SetUrlHash = (function (jQuery, window) {
      * Publicly exposes a reference to the otherwise private setUrlHash function
      */
     return setUrlHash;
-})(jQuery, window);
\ No newline at end of file
+})(jQuery, window);
-- 
1.7.9.5

